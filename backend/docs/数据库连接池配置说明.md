# 数据库连接池配置说明

## 📋 概述

本系统已实现数据库连接池优化，支持通过环境变量动态配置连接池参数。

## 🔧 配置参数

### 环境变量说明

| 环境变量 | 默认值 | 说明 |
|---------|-------|------|
| `DB_CONNECTION_LIMIT` | 50 | 最大连接数（推荐：CPU核心数 × 10） |
| `DB_POOL_TIMEOUT` | 20 | 连接池超时时间（秒） |
| `DB_CONNECT_TIMEOUT` | 10 | 连接超时时间（秒） |
| `DB_QUERY_TIMEOUT` | 30 | 查询超时时间（秒） |
| `DB_STATEMENT_TIMEOUT` | 30000 | SQL语句超时（毫秒） |
| `DB_IDLE_TIMEOUT` | 600 | 空闲连接超时（秒） |
| `DB_POOL_MONITORING` | true | 启用连接池监控 |
| `DB_POOL_LOG_LEVEL` | warn | 日志级别：error, warn, info, query |

### 连接字符串构建

系统会自动将连接池参数添加到 `DATABASE_URL` 中：

```
原始: postgresql://user:pass@host:port/db?schema=public
构建后: postgresql://user:pass@host:port/db?schema=public&connection_limit=50&pool_timeout=20&...
```

## ✅ 验证配置

### 方法1: 检查启动日志

启动应用后，查看日志中是否包含连接池配置信息：

```bash
# Docker 环境
docker-compose logs backend | grep "数据库连接池配置"

# 本地环境
npm run start:dev | grep "数据库连接池配置"
```

预期输出：
```
[PrismaService] 数据库连接池配置: 最大连接数=50, 连接超时=10s, 查询超时=30s
[PrismaService] 数据库连接成功
```

### 方法2: 检查环境变量

```bash
# Docker 环境
docker-compose exec backend env | grep DB_

# 本地环境
# 检查 .env 文件或环境变量
```

### 方法3: 应用启动测试

1. 启动应用
2. 检查是否成功连接到数据库
3. 查看是否有连接池相关的错误日志

## 📊 推荐配置（不同场景）

### 开发环境
```env
DB_CONNECTION_LIMIT=10
DB_POOL_TIMEOUT=10
DB_CONNECT_TIMEOUT=5
DB_QUERY_TIMEOUT=20
```

### 测试环境
```env
DB_CONNECTION_LIMIT=30
DB_POOL_TIMEOUT=15
DB_CONNECT_TIMEOUT=8
DB_QUERY_TIMEOUT=25
```

### 生产环境
```env
DB_CONNECTION_LIMIT=50
DB_POOL_TIMEOUT=20
DB_CONNECT_TIMEOUT=10
DB_QUERY_TIMEOUT=30
```

### 高并发场景
```env
DB_CONNECTION_LIMIT=80
DB_POOL_TIMEOUT=30
DB_CONNECT_TIMEOUT=15
DB_QUERY_TIMEOUT=60
```

## ⚠️ 注意事项

1. **连接数限制**: 确保 `DB_CONNECTION_LIMIT` 不超过 PostgreSQL 的 `max_connections` 配置
2. **多实例部署**: 如果有多个应用实例，总连接数 = `DB_CONNECTION_LIMIT × 实例数`
3. **PostgreSQL 配置**: 建议 PostgreSQL 的 `max_connections` 设置为应用连接数的 1.5-2 倍
4. **已有参数**: 如果 `DATABASE_URL` 已包含连接池参数，系统会使用现有配置并发出警告

## 🔍 故障排查

### 问题1: 连接池配置未生效

**症状**: 日志中没有连接池配置信息

**解决方案**:
1. 检查环境变量是否正确设置
2. 检查 `DATABASE_URL` 是否已包含连接池参数（如果包含，系统会使用现有配置）
3. 重启应用

### 问题2: 连接数不足

**症状**: 出现 "too many clients" 错误

**解决方案**:
1. 增加 `DB_CONNECTION_LIMIT`
2. 检查 PostgreSQL 的 `max_connections` 配置
3. 优化查询，减少连接占用时间

### 问题3: 连接超时

**症状**: 出现连接超时错误

**解决方案**:
1. 增加 `DB_CONNECT_TIMEOUT`
2. 检查数据库服务器是否正常运行
3. 检查网络连接

## 📈 性能优化建议

1. **监控连接池使用率**: 定期检查连接池使用情况
2. **调整连接数**: 根据实际负载动态调整 `DB_CONNECTION_LIMIT`
3. **优化查询**: 减少慢查询，提高连接释放速度
4. **使用连接池中间件**: 高并发场景考虑使用 PgBouncer

## 🔗 相关文档

- [Prisma 连接池文档](https://www.prisma.io/docs/concepts/components/prisma-client/connection-management)
- [PostgreSQL 连接配置](https://www.postgresql.org/docs/current/runtime-config-connection.html)

