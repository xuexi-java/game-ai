# 紧急规则业务逻辑修改说明

## 📋 修改概述

根据新的业务需求，我们修改了紧急规则管理的业务逻辑，使其主要基于问题类型来设置工单优先级。

## 🎯 新的业务逻辑

### 核心原则
1. **问题类型是核心**：紧急规则必须至少选择一个问题类型作为匹配条件
2. **优先级计算**：工单优先级 = 问题类型基础权重 + 匹配的紧急规则权重加成
3. **简化匹配**：移除了不必要的复杂匹配条件（如 AI 意图、工单优先级等）

### 工作流程
1. 管理员在后台管理问题类型（增删改查）
2. 管理员创建紧急规则，必须选择至少一个问题类型
3. 玩家提交工单时，选择问题类型
4. 系统计算优先级：
   - 基础分数 = 问题类型权重计算（maxWeight + sumOfOtherWeights * 0.3）
   - 匹配紧急规则，累加规则权重
   - 最终分数 = 基础分数 + 规则权重加成（最高200分）

## 🔧 修改内容

### 1. 数据库结构

**无需修改数据库表结构**，因为 `UrgencyRule.conditions` 是 JSON 字段，已经支持存储 `issueTypeIds`。

**注意**：现有数据中如果 `conditions.issueTypeIds` 为空，规则将不会生效。

### 2. 后端修改

#### 2.1 DTO 修改 (`urgency-rule/dto/create-urgency-rule.dto.ts`)

- ✅ `UrgencyRuleConditionsDto.issueTypeIds` 改为**必需字段**，至少选择一个
- ✅ 移除了 `intent` 和 `priority` 字段（不再使用）
- ✅ 保留了可选字段：`keywords`、`identityStatus`、`gameId`、`serverId`

#### 2.2 服务修改 (`urgency-rule/urgency-rule.service.ts`)

- ✅ `matchRule` 方法简化：
  - 问题类型匹配是**必需条件**（核心匹配）
  - 如果规则没有设置问题类型，直接返回 `false`
  - 其他条件（关键词、身份、游戏、区服）为可选附加条件

#### 2.3 优先级计算修改 (`ticket/ticket-priority.service.ts`)

- ✅ 新增 `calculateUrgencyRuleBonus` 方法：计算紧急规则权重加成
- ✅ `calculatePriority` 方法更新：
  - 先计算基础分数（基于问题类型权重）
  - 再匹配紧急规则并累加权重
  - 最终分数 = 基础分数 + 规则权重加成（最高200分）

#### 2.4 工单创建修改 (`ticket/ticket.service.ts`)

- ✅ 创建工单流程调整：
  1. 先创建工单（临时设置优先级）
  2. 计算优先级（包含紧急规则匹配）
  3. 更新工单的优先级和分数

### 3. 前端修改

#### 3.1 紧急规则管理页面 (`admin-portal/src/pages/Settings/UrgencyRules/index.tsx`)

- ✅ **问题类型字段**：
  - 改为**必填字段**，添加验证规则
  - 显示问题类型的权重信息
  - 只显示已启用的问题类型
  - 按 `sortOrder` 排序
  - 添加提示说明

- ✅ **表单优化**：
  - 移除了 `intent` 和 `priority` 字段
  - 将可选条件分组显示，添加说明文字
  - 优化了字段标签和提示

- ✅ **显示优化**：
  - 如果规则没有设置问题类型，显示红色警告标签
  - 移除了意图和优先级的显示

## 📊 优先级计算示例

### 示例 1：基础计算
- 玩家选择问题类型：["充值未到账" (权重95), "道具丢失" (权重75)]
- 基础分数 = 95 + (75 * 0.3) = 95 + 22.5 = 118（四舍五入）

### 示例 2：包含紧急规则
- 基础分数：118
- 匹配到紧急规则："充值问题优先"（权重80）
- 最终分数 = 118 + 80 = 198
- 优先级：URGENT（因为 198 >= 150）

### 示例 3：多个规则匹配
- 基础分数：100
- 匹配到规则1："充值问题优先"（权重80）
- 匹配到规则2："支付验证用户优先"（权重50）
- 最终分数 = 100 + 80 + 50 = 230（限制为200）
- 优先级：URGENT

## ⚠️ 注意事项

### 数据迁移
1. **现有规则检查**：检查现有紧急规则，确保都有设置 `issueTypeIds`
2. **无效规则处理**：没有设置问题类型的规则将不会生效，建议管理员重新配置

### 兼容性
- ✅ 向后兼容：现有规则如果设置了 `issueTypeIds`，可以正常工作
- ⚠️ 需要更新：没有设置 `issueTypeIds` 的规则需要管理员手动更新

### 性能考虑
- 优先级计算在工单创建时进行，包含数据库查询
- 紧急规则匹配会查询所有启用的规则，建议控制规则数量（建议 < 50 条）

## 🧪 测试建议

1. **创建规则测试**：
   - 测试不选择问题类型时，应该提示错误
   - 测试选择多个问题类型
   - 测试可选条件的组合

2. **优先级计算测试**：
   - 测试只有问题类型的情况
   - 测试匹配单个紧急规则
   - 测试匹配多个紧急规则
   - 测试分数上限（200分）

3. **匹配逻辑测试**：
   - 测试问题类型匹配
   - 测试可选条件（关键词、身份、游戏、区服）
   - 测试规则未启用的情况

## 📝 后续优化建议

1. **规则优先级**：考虑为规则添加优先级，避免多个规则同时匹配时的冲突
2. **规则模板**：提供常用规则的模板，方便快速创建
3. **规则测试**：提供规则测试功能，可以预览规则匹配效果
4. **性能优化**：如果规则数量很多，考虑缓存规则列表

---

**修改日期**：2024
**修改人**：AI Assistant
**版本**：v2.0

