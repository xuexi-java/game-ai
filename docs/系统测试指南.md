# 系统测试指南

## 测试概述

本系统采用多层次的测试策略，包括：
- **单元测试**：测试单个函数/方法
- **集成测试**：测试模块间的交互
- **E2E测试**：测试完整的业务流程
- **前端测试**：测试 React 组件和逻辑

## 测试架构

```
测试金字塔
    /\
   /E2E\        ← 少量端到端测试
  /------\
 /集成测试\      ← 中等数量的集成测试
/----------\
/  单元测试  \    ← 大量单元测试
/------------\
```

## 后端测试

### 测试框架
- **Jest** - 测试运行器和断言库
- **@nestjs/testing** - NestJS 测试工具
- **Supertest** - HTTP 断言库（用于 E2E 测试）

### 测试配置

配置文件：`backend/jest.config.js`

```javascript
module.exports = {
  moduleFileExtensions: ['js', 'json', 'ts'],
  rootDir: 'src',
  testRegex: '.*\\.spec\\.ts$',
  transform: {
    '^.+\\.(t|j)s$': 'ts-jest',
  },
  collectCoverageFrom: [
    '**/*.(t|j)s',
    '!**/*.spec.ts',
    '!**/*.dto.ts',
    '!**/main.ts',
  ],
  coverageDirectory: '../coverage',
  testEnvironment: 'node',
};
```

### 运行测试

```bash
# 运行所有测试
cd backend
npm test

# 监听模式（开发时推荐）
npm run test:watch

# 生成覆盖率报告
npm run test:cov

# 运行 E2E 测试
npm run test:e2e

# 调试模式
npm run test:debug
```

### 测试文件命名规范

- 单元测试：`*.spec.ts`（与源文件同目录）
- E2E 测试：`test/**/*.e2e-spec.ts`

### 覆盖率目标

- **语句覆盖率**: > 80%
- **分支覆盖率**: > 75%
- **函数覆盖率**: > 80%
- **行覆盖率**: > 80%

## 前端测试

### 测试框架
- **Vitest** - 快速的前端测试框架
- **@testing-library/react** - React 组件测试工具
- **@testing-library/jest-dom** - DOM 断言扩展

### 配置前端测试

#### 1. 安装依赖

```bash
# 管理端
cd admin-portal
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom

# 玩家端
cd player-app
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom
```

#### 2. 创建测试配置

创建 `vitest.config.ts` 文件

## 测试类型详解

### 1. 单元测试

测试单个函数、方法或类的功能。

**示例：服务测试**

```typescript
describe('UserService', () => {
  let service: UserService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        UserService,
        {
          provide: PrismaService,
          useValue: {
            user: {
              findMany: jest.fn(),
              create: jest.fn(),
            },
          },
        },
      ],
    }).compile();

    service = module.get<UserService>(UserService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('应该创建用户', async () => {
    const userData = { username: 'test', password: '123456' };
    const expectedUser = { id: '1', ...userData };

    jest.spyOn(prisma.user, 'create').mockResolvedValue(expectedUser);

    const result = await service.create(userData);
    expect(result).toEqual(expectedUser);
  });
});
```

### 2. 集成测试

测试多个模块的协作。

**示例：Controller + Service 测试**

```typescript
describe('AuthController (Integration)', () => {
  let app: INestApplication;
  let prisma: PrismaService;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleRef.createNestApplication();
    prisma = moduleRef.get<PrismaService>(PrismaService);
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('应该登录成功', async () => {
    // 创建测试用户
    await prisma.user.create({
      data: {
        username: 'testuser',
        password: 'hashed_password',
        role: 'AGENT',
      },
    });

    const response = await request(app.getHttpServer())
      .post('/api/v1/auth/login')
      .send({ username: 'testuser', password: 'password' });

    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('accessToken');
  });
});
```

### 3. E2E 测试

测试完整的业务流程。

**示例：工单创建流程**

```typescript
describe('Ticket E2E', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleRef.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('应该完成工单创建流程', async () => {
    // 1. 创建工单
    const createResponse = await request(app.getHttpServer())
      .post('/api/v1/tickets')
      .send({
        gameId: 'game1',
        playerIdOrName: 'player1',
        description: '测试问题',
      });

    expect(createResponse.status).toBe(201);
    const ticketId = createResponse.body.id;

    // 2. 查询工单
    const getResponse = await request(app.getHttpServer())
      .get(`/api/v1/tickets/${ticketId}`);

    expect(getResponse.status).toBe(200);
    expect(getResponse.body.id).toBe(ticketId);
  });
});
```

### 4. 前端组件测试

测试 React 组件。

**示例：组件测试**

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { LoginPage } from './LoginPage';

describe('LoginPage', () => {
  it('应该渲染登录表单', () => {
    render(<LoginPage />);
    expect(screen.getByLabelText('用户名')).toBeInTheDocument();
    expect(screen.getByLabelText('密码')).toBeInTheDocument();
  });

  it('应该处理登录提交', async () => {
    const mockLogin = jest.fn();
    render(<LoginPage onLogin={mockLogin} />);
    
    fireEvent.change(screen.getByLabelText('用户名'), {
      target: { value: 'admin' },
    });
    fireEvent.change(screen.getByLabelText('密码'), {
      target: { value: 'password' },
    });
    fireEvent.click(screen.getByText('登录'));

    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalledWith({
        username: 'admin',
        password: 'password',
      });
    });
  });
});
```

## 测试最佳实践

### 1. 测试结构（AAA 模式）

```typescript
it('应该做某事', () => {
  // Arrange（准备）
  const input = 'test';
  
  // Act（执行）
  const result = functionToTest(input);
  
  // Assert（断言）
  expect(result).toBe('expected');
});
```

### 2. 测试命名

- 使用描述性的测试名称
- 格式：`应该 [预期行为] 当 [条件]`
- 示例：`应该返回用户列表 当查询成功时`

### 3. Mock 和 Stub

```typescript
// Mock 外部依赖
jest.mock('../services/api.service');

// Stub 返回值
jest.spyOn(service, 'method').mockResolvedValue(mockData);
```

### 4. 测试隔离

- 每个测试应该独立
- 使用 `beforeEach` 和 `afterEach` 清理
- 不依赖其他测试的执行顺序

### 5. 边界测试

- 测试正常情况
- 测试异常情况
- 测试边界值
- 测试空值/null/undefined

## 测试数据管理

### 使用测试数据库

```typescript
// 使用独立的测试数据库
const TEST_DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';

beforeAll(async () => {
  // 运行迁移
  await exec('npx prisma migrate deploy');
});

afterEach(async () => {
  // 清理测试数据
  await prisma.user.deleteMany();
});
```

### 使用 Fixtures

```typescript
// test/fixtures/user.fixture.ts
export const createTestUser = (overrides = {}) => ({
  username: 'testuser',
  password: 'hashed_password',
  role: 'AGENT',
  ...overrides,
});
```

## CI/CD 集成

### GitHub Actions 示例

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd backend && npm ci
      
      - name: Run tests
        run: |
          cd backend && npm test
      
      - name: Generate coverage
        run: |
          cd backend && npm run test:cov
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

## 测试覆盖率报告

### 查看覆盖率

```bash
# 生成覆盖率报告
cd backend
npm run test:cov

# 打开 HTML 报告
open coverage/lcov-report/index.html
```

### 覆盖率阈值

在 `jest.config.js` 中设置：

```javascript
coverageThreshold: {
  global: {
    branches: 75,
    functions: 80,
    lines: 80,
    statements: 80,
  },
},
```

## 常见问题

### 1. 测试超时

```typescript
// 增加超时时间
jest.setTimeout(10000); // 10秒
```

### 2. 异步测试

```typescript
// 使用 async/await
it('应该处理异步操作', async () => {
  const result = await asyncFunction();
  expect(result).toBeDefined();
});
```

### 3. Mock 模块

```typescript
// Mock 整个模块
jest.mock('../services/api.service', () => ({
  ApiService: jest.fn().mockImplementation(() => ({
    get: jest.fn(),
  })),
}));
```

### 4. 数据库连接

```typescript
// 使用测试数据库
process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test_db';
```

## 测试检查清单

### 后端测试
- [ ] 所有 Service 都有单元测试
- [ ] 所有 Controller 都有集成测试
- [ ] 关键业务流程有 E2E 测试
- [ ] 覆盖率 > 80%
- [ ] Mock 外部依赖（数据库、API等）

### 前端测试
- [ ] 关键组件有测试
- [ ] 用户交互有测试
- [ ] API 调用有 Mock
- [ ] 路由有测试

### 整体
- [ ] CI/CD 集成测试
- [ ] 测试文档完整
- [ ] 测试数据管理
- [ ] 性能测试（可选）

