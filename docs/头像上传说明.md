# 头像上传功能说明

## 当前实现

### 存储方式
系统支持两种存储方式，**自动检测并选择**：

1. **阿里云 OSS（推荐）**：如果配置了 OSS 相关环境变量，自动使用 OSS 存储
2. **本地存储**：如果未配置 OSS，自动使用本地文件系统存储

### 存储路径

- **OSS 存储路径**：`avatars/{userId}/{uuid}.{ext}`
- **本地存储路径**：`./uploads/avatars/{userId}/{uuid}.{ext}`

### URL 格式

- **OSS URL**：完整的 HTTPS URL，例如：`https://your-bucket.oss-cn-shenzhen.aliyuncs.com/avatars/user-123/xxx.jpg`
- **本地 URL**：相对路径，例如：`/uploads/avatars/user-123/xxx.jpg`

## 推荐配置

### 生产环境（强烈推荐使用 OSS）

**优势：**
- ✅ 高性能 CDN 加速
- ✅ 高可用性和可靠性
- ✅ 自动备份和容灾
- ✅ 节省服务器存储空间
- ✅ 支持图片处理（缩放、裁剪等）
- ✅ 更好的安全控制

**配置步骤：**

1. 在 `backend/.env` 文件中添加 OSS 配置：
```env
OSS_ACCESS_KEY_ID=your-access-key-id
OSS_ACCESS_KEY_SECRET=your-access-key-secret
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-shenzhen
OSS_ENDPOINT=oss-cn-shenzhen.aliyuncs.com
```

2. 确保 OSS Bucket 的访问权限设置为：
   - **开发环境**：可以设置为"公共读"（方便测试）
   - **生产环境**：建议设置为"私有"，使用签名 URL 访问（更安全）

### 开发环境（可以使用本地存储）

如果暂时不想配置 OSS，系统会自动使用本地存储：
- 文件存储在 `backend/uploads/avatars/` 目录
- 需要确保该目录有写入权限
- 前端通过 API 服务器访问本地文件

## 头像显示

系统已统一处理头像 URL 解析：
- 如果 URL 是完整的 HTTPS URL（OSS），直接使用
- 如果 URL 是相对路径（本地存储），自动加上 API 基础 URL

**所有使用头像的地方都会自动正确显示**，包括：
- 右上角用户信息
- 个人资料页面
- 其他显示用户头像的地方

## 文件限制

- **支持格式**：JPG、PNG、GIF、WEBP
- **文件大小**：最大 5MB
- **文件命名**：使用 UUID 确保唯一性

## 注意事项

1. **OSS 配置后**：上传的头像会直接返回完整的 OSS URL，无需额外处理
2. **本地存储**：需要确保后端服务器可以访问 `uploads` 目录
3. **URL 解析**：前端已统一使用 `resolveAvatarUrl` 函数处理，确保所有地方显示一致

