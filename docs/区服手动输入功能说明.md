# 区服手动输入功能说明

## 修改原因

由于没有游戏的完整数据库，无法提供准确的区服列表供玩家选择，因此将区服选择改为手动输入。

## 主要变更

### 1. 前端修改 (IdentityCheck 页面)

**变更内容:**
- 将"选择区服"下拉列表改为"输入区服"文本输入框
- 移除区服列表加载和联动逻辑
- 玩家可以自由输入区服名称（例如：一区、二区、电信一区等）

**表单字段变更:**
```typescript
// 之前
serverId: string  // 从下拉列表选择的区服 ID

// 现在
serverName: string  // 玩家手动输入的区服名称
```

**验证规则:**
- 必填项
- 最大长度 50 个字符

### 2. 后端修改

**API 端点:** `POST /api/v1/tickets/check-open-by-issue-type`

**参数变更:**
```typescript
// 之前
{
  gameId: string;
  serverId: string;  // 必填
  playerIdOrName: string;
  issueTypeId: string;
}

// 现在
{
  gameId: string;
  serverId?: string;  // 可选，可能是 serverId 或 serverName
  playerIdOrName: string;
  issueTypeId: string;
}
```

**查询逻辑变更:**
- 支持同时匹配 `serverId` 或 `serverName`
- 使用 OR 条件查询，兼容两种方式

```typescript
where.OR = [
  { serverId: serverIdOrName },
  { serverName: serverIdOrName },
];
```

### 3. 数据存储

工单创建时的数据结构：
```typescript
{
  gameId: "1",
  serverId: null,           // 不再使用
  serverName: "一区",       // 玩家输入的区服名称
  playerIdOrName: "test123",
  issueTypeIds: ["issue-type-01"]
}
```

## 用户体验

### 优点
1. **灵活性**: 玩家可以输入任何区服名称，不受限于预定义列表
2. **简化流程**: 不需要维护复杂的游戏-区服关系数据
3. **适应性强**: 适用于各种游戏和区服命名方式

### 注意事项
1. **输入规范**: 玩家可能输入不规范的区服名称
2. **重复检测**: 基于 serverName 字符串匹配，需要完全一致才能检测到重复工单
3. **数据统计**: 区服统计需要基于 serverName 字段进行

## 示例

### 玩家输入示例
```
游戏: 弹弹堂
区服: 一区
角色: test123
问题类型: 充值未到账
```

### API 请求示例
```json
{
  "gameId": "1",
  "serverId": "一区",
  "playerIdOrName": "test123",
  "issueTypeId": "issue-type-01"
}
```

### 数据库记录
```sql
INSERT INTO "Ticket" (
  gameId, 
  serverId, 
  serverName, 
  playerIdOrName, 
  ...
) VALUES (
  '1',
  NULL,
  '一区',
  'test123',
  ...
);
```

## 向后兼容

- 保留 `serverId` 字段，但设置为 NULL
- 查询时同时支持 `serverId` 和 `serverName`
- 旧数据（有 serverId）仍然可以正常查询

## 后续优化建议

1. **输入提示**: 提供常见区服名称的自动完成建议
2. **格式规范**: 添加输入格式提示或示例
3. **数据清洗**: 定期清理和规范化区服名称数据
4. **统计优化**: 建立区服名称映射表，便于数据统计和分析

## 测试要点

1. **基本输入测试**
   - 输入常见区服名称（一区、二区等）
   - 输入特殊字符
   - 输入超长文本

2. **重复检测测试**
   - 相同区服名称应该能检测到重复工单
   - 不同区服名称不应触发重复检测
   - 大小写敏感性测试

3. **数据持久化测试**
   - 验证 serverName 正确保存到数据库
   - 验证 serverId 为 NULL

## 数据库查询

查看工单的区服信息：
```sql
SELECT 
  ticketNo,
  gameId,
  serverId,
  serverName,
  playerIdOrName,
  createdAt
FROM "Ticket"
WHERE deletedAt IS NULL
ORDER BY createdAt DESC
LIMIT 10;
```

统计各区服的工单数量：
```sql
SELECT 
  serverName,
  COUNT(*) as ticket_count
FROM "Ticket"
WHERE deletedAt IS NULL
  AND serverName IS NOT NULL
GROUP BY serverName
ORDER BY ticket_count DESC;
```

## 相关文件

- `player-app/src/pages/IdentityCheck/index.tsx` - 前端身份验证页面
- `backend/src/ticket/ticket.service.ts` - 后端工单服务
- `backend/src/ticket/ticket.controller.ts` - 后端工单控制器
- `player-app/src/stores/ticketStore.ts` - 前端状态管理

## 完成时间

2025-11-18
