# 问题类型下拉列表功能测试指南

## 测试环境

- 前端: http://localhost:5173
- 后端: http://localhost:3000
- 数据库: PostgreSQL (端口 5432)

## 测试账号

### 玩家端测试
- 游戏: 弹弹堂 (ID: 1)
- 区服: 一区 (ID: server-1)
- 角色: test123 或任意角色名

### 管理端测试
- 用户名: admin
- 密码: admin123

## 测试步骤

### 1. 基本流程测试

#### 步骤 1.1: 访问玩家端
1. 打开浏览器访问 http://localhost:5173
2. 应该看到"身份验证"页面

#### 步骤 1.2: 填写身份信息
1. **选择游戏**: 从下拉列表选择"弹弹堂"
2. **选择区服**: 区服列表应该自动加载，选择"一区"
3. **输入角色**: 输入 "test123"
4. **选择问题类型**: 从下拉列表选择一个问题类型，例如"💰 充值未到账"

#### 步骤 1.3: 提交表单
1. 点击"下一步"按钮
2. 应该跳转到"问题反馈表单"页面
3. 注意：问题类型选择已经不在这个页面了

#### 步骤 1.4: 填写问题详情
1. 输入问题描述
2. （可选）选择问题发生时间
3. （可选）上传截图
4. （可选）输入充值订单号
5. 点击"提交并开始咨询"

#### 步骤 1.5: 验证工单创建
1. 应该跳转到聊天页面
2. 工单应该成功创建

### 2. 重复问题类型检测测试

#### 步骤 2.1: 创建第一个工单
1. 按照"基本流程测试"创建一个工单
2. 选择问题类型: "💰 充值未到账"
3. 记住使用的游戏、区服和角色信息
4. **不要关闭这个工单**

#### 步骤 2.2: 尝试创建相同问题类型的工单
1. 返回首页或刷新页面
2. 再次填写身份信息（使用相同的游戏、区服、角色）
3. 选择相同的问题类型: "💰 充值未到账"
4. 点击"下一步"

#### 步骤 2.3: 验证弹窗提示
1. 应该弹出确认对话框
2. 对话框标题: "检测到未完成的工单"
3. 对话框内容: 显示工单号，询问是否继续处理
4. 两个按钮: "继续处理" 和 "创建新工单"

#### 步骤 2.4: 测试"继续处理"
1. 点击"继续处理"按钮
2. 应该跳转到之前的工单页面
3. 可以继续之前的对话

#### 步骤 2.5: 测试"创建新工单"
1. 重复步骤 2.2
2. 这次点击"创建新工单"按钮
3. 应该跳转到"问题反馈表单"页面
4. 可以创建新的工单

### 3. 不同问题类型测试

#### 步骤 3.1: 创建不同问题类型的工单
1. 使用相同的游戏、区服、角色
2. 选择不同的问题类型，例如"🎮 游戏BUG"
3. 点击"下一步"

#### 步骤 3.2: 验证不触发重复检测
1. 应该直接跳转到"问题反馈表单"页面
2. 不应该弹出确认对话框
3. 可以正常创建新工单

### 4. 不同区服测试

#### 步骤 4.1: 创建不同区服的工单
1. 使用相同的游戏和角色
2. 选择不同的区服，例如"二区"
3. 选择相同的问题类型
4. 点击"下一步"

#### 步骤 4.2: 验证不触发重复检测
1. 应该直接跳转到"问题反馈表单"页面
2. 不应该弹出确认对话框

### 5. UI/UX 测试

#### 步骤 5.1: 区服联动测试
1. 不选择游戏，区服下拉列表应该是禁用状态
2. 选择游戏后，区服下拉列表应该启用
3. 切换游戏，区服列表应该更新

#### 步骤 5.2: 表单验证测试
1. 不填写任何字段，点击"下一步"
2. 应该显示验证错误信息
3. 逐个填写字段，验证错误应该消失

#### 步骤 5.3: 问题类型下拉列表测试
1. 点击问题类型下拉列表
2. 应该显示所有启用的问题类型
3. 每个选项应该显示图标和名称
4. 支持搜索功能（输入关键词过滤）

## API 测试

### 测试新增的 API 端点

```powershell
# 测试检查相同问题类型的未完成工单
curl -Method POST `
  -Uri "http://localhost:3000/api/v1/tickets/check-open-by-issue-type" `
  -ContentType "application/json" `
  -Body '{"gameId":"1","serverId":"server-1","playerIdOrName":"test123","issueTypeId":"issue-type-01"}' | ConvertFrom-Json
```

**预期响应（无未完成工单）:**
```json
{
  "success": true,
  "data": {
    "hasOpenTicket": false,
    "ticket": null
  }
}
```

**预期响应（有未完成工单）:**
```json
{
  "success": true,
  "data": {
    "hasOpenTicket": true,
    "ticket": {
      "id": "uuid",
      "ticketNo": "T-20251118-001",
      "token": "token-string"
    }
  }
}
```

## 数据库验证

### 查询工单和问题类型关联

```sql
-- 查看某个玩家的所有工单及其问题类型
SELECT 
  t.ticketNo,
  t.playerIdOrName,
  t.status,
  it.name as issueTypeName,
  it.icon,
  t.createdAt
FROM "Ticket" t
LEFT JOIN "TicketIssueType" tit ON t.id = tit.ticketId
LEFT JOIN "IssueType" it ON tit.issueTypeId = it.id
WHERE t.gameId = '1'
  AND t.serverId = 'server-1'
  AND t.playerIdOrName = 'test123'
  AND t.deletedAt IS NULL
ORDER BY t.createdAt DESC;
```

### 查询未完成的工单

```sql
-- 查看未完成的工单
SELECT 
  t.ticketNo,
  t.playerIdOrName,
  t.status,
  it.name as issueTypeName,
  t.createdAt
FROM "Ticket" t
LEFT JOIN "TicketIssueType" tit ON t.id = tit.ticketId
LEFT JOIN "IssueType" it ON tit.issueTypeId = it.id
WHERE t.status != 'CLOSED'
  AND t.deletedAt IS NULL
ORDER BY t.createdAt DESC;
```

## 常见问题排查

### 问题 1: 区服列表不显示
**原因**: 游戏数据未正确加载
**解决**: 
1. 检查后端服务是否运行
2. 检查数据库中是否有游戏和区服数据
3. 运行 `npm run seed` 重新初始化数据

### 问题 2: 问题类型列表为空
**原因**: 问题类型数据未加载
**解决**:
1. 检查后端 API: http://localhost:3000/api/v1/issue-types
2. 确认数据库中有问题类型数据
3. 检查浏览器控制台是否有错误

### 问题 3: 重复检测不工作
**原因**: API 调用失败或逻辑错误
**解决**:
1. 打开浏览器开发者工具
2. 查看 Network 标签，检查 API 请求
3. 查看 Console 标签，检查 JavaScript 错误
4. 检查后端日志

### 问题 4: TypeScript 编译错误
**原因**: Prisma Client 未重新生成
**解决**:
1. 停止后端服务
2. 运行 `npx prisma generate`
3. 重启后端服务

## 测试检查清单

- [ ] 基本流程：选择游戏 → 区服 → 角色 → 问题类型 → 提交
- [ ] 区服联动：选择游戏后区服列表正确加载
- [ ] 问题类型下拉：显示所有启用的问题类型
- [ ] 重复检测：相同问题类型触发确认对话框
- [ ] 继续处理：点击后跳转到原工单
- [ ] 创建新工单：点击后可以创建新工单
- [ ] 不同问题类型：不触发重复检测
- [ ] 不同区服：不触发重复检测
- [ ] 表单验证：所有必填字段都有验证
- [ ] 数据持久化：工单和问题类型正确关联

## 性能测试

1. **页面加载速度**: 首页应在 1 秒内加载完成
2. **API 响应时间**: 所有 API 调用应在 500ms 内完成
3. **下拉列表性能**: 问题类型列表应流畅显示（即使有 100+ 选项）

## 浏览器兼容性

测试以下浏览器:
- [ ] Chrome (最新版本)
- [ ] Firefox (最新版本)
- [ ] Edge (最新版本)
- [ ] Safari (如果可用)

## 测试完成标准

所有测试步骤通过，且:
1. 无 JavaScript 错误
2. 无 API 调用失败
3. 数据正确保存到数据库
4. UI 显示正常，无样式问题
5. 用户体验流畅，无卡顿
