# 日志系统优化实施指南

## 优化内容概览

### ✅ 已实现的优化

1. **异步批量写入**
   - 使用写入队列缓冲日志
   - 批量写入（默认100条或100ms）
   - 异步非阻塞写入

2. **敏感信息过滤**
   - 自动检测并替换敏感字段
   - 支持配置敏感字段列表
   - 递归过滤嵌套对象

3. **结构化日志（JSON格式）**
   - 支持 JSON 和文本两种格式
   - 通过环境变量切换
   - 向后兼容文本格式

4. **日志压缩和归档**
   - 自动压缩7天前的日志
   - 归档到 `logs/archive/` 目录
   - 使用 gzip 压缩

5. **错误处理和降级**
   - 捕获写入错误
   - 自动降级到控制台输出
   - 错误计数和恢复机制

6. **日志采样**
   - 支持按比例采样
   - 错误日志始终记录
   - 可配置采样率

## 配置说明

### 环境变量

```env
# 日志级别: ERROR, WARN, LOG, DEBUG, VERBOSE
LOG_LEVEL=LOG

# 日志目录（可选，默认为 ./logs）
LOG_DIR=./logs

# 日志格式: text 或 json
LOG_FORMAT=text

# 是否启用压缩（默认 true）
LOG_ENABLE_COMPRESSION=true

# 归档天数（默认 7 天）
LOG_ARCHIVE_AFTER_DAYS=7

# 批量大小（默认 100 条）
LOG_BATCH_SIZE=100

# 批量间隔（默认 100ms）
LOG_BATCH_INTERVAL=100

# 采样率（0-1，默认 1，表示记录所有日志）
LOG_SAMPLING_RATE=1

# 敏感字段列表（逗号分隔）
LOG_SENSITIVE_FIELDS=password,token,secret,apiKey,authorization
```

### 推荐配置

#### 生产环境
```env
LOG_LEVEL=WARN
LOG_FORMAT=json
LOG_ENABLE_COMPRESSION=true
LOG_ARCHIVE_AFTER_DAYS=30
LOG_BATCH_SIZE=100
LOG_BATCH_INTERVAL=100
LOG_SAMPLING_RATE=0.1  # 10% 采样率
```

#### 开发环境
```env
LOG_LEVEL=DEBUG
LOG_FORMAT=text
LOG_ENABLE_COMPRESSION=false
LOG_SAMPLING_RATE=1  # 100% 采样率
```

## 使用方法

### 替换现有 LoggerService

1. **备份现有文件**
```bash
cp backend/src/common/logger/logger.service.ts backend/src/common/logger/logger.service.backup.ts
```

2. **使用优化版本**
```bash
cp backend/src/common/logger/logger.service.optimized.ts backend/src/common/logger/logger.service.ts
```

3. **安装依赖**（如果需要）
```bash
cd backend
npm install --save-dev @types/node
```

### 代码使用（无需修改）

优化后的 LoggerService 完全兼容现有代码，无需修改任何业务代码。

```typescript
// 现有代码无需修改
import { CustomLogger } from '../common/logger/custom-logger';

export class UserService {
  private readonly logger = new CustomLogger(UserService.name);
  
  async createUser(data: CreateUserDto) {
    this.logger.log('开始创建用户', { username: data.username });
    // ...
  }
}
```

## 性能对比

### 优化前
- 同步写入，每条日志立即写入
- I/O 阻塞主线程
- 无缓冲，频繁文件操作

### 优化后
- 异步批量写入，非阻塞
- 批量处理，减少 I/O 次数
- 写入队列缓冲，提高吞吐量

### 预期提升
- **I/O 阻塞减少**: 90%+
- **日志写入延迟**: 降低 80%+
- **系统吞吐量**: 提升 10-20%
- **磁盘空间**: 压缩节省 70%+

## 监控和调试

### 检查日志写入状态

```typescript
// 在应用关闭时确保日志已刷新
process.on('SIGTERM', async () => {
  await logger.flushQueue();
  process.exit(0);
});
```

### 查看归档日志

```bash
# 查看归档目录
ls -lh logs/archive/

# 解压查看
gunzip -c logs/archive/backend-2025-11-20.log.gz | tail -100
```

### 检查降级模式

如果日志系统进入降级模式，会在控制台输出警告：
```
Too many write errors, entering fallback mode (console only)
```

## 注意事项

1. **采样率设置**
   - 生产环境建议设置 0.1-0.5（10%-50%）
   - 错误日志始终记录，不受采样影响
   - 开发环境建议设置为 1（100%）

2. **敏感字段配置**
   - 默认包含常见敏感字段
   - 可根据业务需求添加自定义字段
   - 过滤是递归的，会处理嵌套对象

3. **批量大小调整**
   - 批量大小过小：频繁写入，性能差
   - 批量大小过大：内存占用高，延迟高
   - 推荐：100-500 条

4. **归档策略**
   - 归档会压缩文件，节省空间
   - 归档后的文件仍可解压查看
   - 建议定期清理归档文件（如保留90天）

## 故障排查

### 问题：日志文件没有生成

1. 检查日志目录权限
2. 检查磁盘空间
3. 查看控制台是否有错误信息

### 问题：日志丢失

1. 检查是否进入降级模式
2. 检查批量写入是否正常
3. 检查采样率设置

### 问题：性能问题

1. 检查批量大小和间隔设置
2. 检查采样率是否过低
3. 检查磁盘 I/O 性能

## 后续优化建议

### 短期（1-2周）
1. 添加日志查询 API
2. 添加性能监控指标
3. 集成日志聚合服务（可选）

### 中期（1-2月）
1. 实现日志可视化界面
2. 添加日志告警机制
3. 实现日志分析功能

### 长期（3-6月）
1. 集成 ELK Stack 或 Loki
2. 实现分布式日志追踪
3. 添加日志机器学习分析

