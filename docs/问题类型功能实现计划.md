# é—®é¢˜ç±»å‹åŠŸèƒ½å®ç°è®¡åˆ’

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### æ ¸å¿ƒéœ€æ±‚
1. **é—®é¢˜ç±»å‹ç®¡ç†**ï¼šç®¡ç†å‘˜å¯ä»¥åœ¨åç«¯è®¾ç½®é—®é¢˜ç±»å‹ï¼ˆåŸºäºç´§æ€¥è§„åˆ™ï¼‰
2. **åŠ¨æ€è¡¨å•**ï¼šç©å®¶åé¦ˆè¡¨å•ç¬¬ä¸€é¡¹æ˜¾ç¤ºé—®é¢˜ç±»å‹é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰
3. **ä¼˜å…ˆçº§è®¡ç®—**ï¼šæ ¹æ®ç©å®¶é€‰æ‹©çš„å¤šä¸ªé—®é¢˜ç±»å‹ï¼Œè®¡ç®—å·¥å•ä¼˜å…ˆçº§
4. **çŠ¶æ€ç®¡ç†**ï¼šå®æ—¶æ›´æ–°å·¥å•çŠ¶æ€
   - åˆå§‹çŠ¶æ€ï¼š`IN_PROGRESS`ï¼ˆå¤„ç†ä¸­ï¼‰
   - ç©å®¶æ–­å¼€ï¼š`WAITING`ï¼ˆå¾…å¤„ç†ï¼‰
   - å®Œæˆï¼š`RESOLVED`ï¼ˆäººå·¥é€‰æ‹©ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡å˜æ›´

### 1. æ–°å¢é—®é¢˜ç±»å‹è¡¨ `IssueType`

```prisma
model IssueType {
  id              String   @id @default(uuid())
  name            String   // é—®é¢˜ç±»å‹åç§°ï¼Œå¦‚"è´¦å·é—®é¢˜"ã€"å……å€¼é—®é¢˜"
  description     String?  @db.Text // é—®é¢˜æè¿°
  priorityWeight  Int      @default(50) // ä¼˜å…ˆçº§æƒé‡ 1-100
  enabled         Boolean  @default(true) // æ˜¯å¦å¯ç”¨
  sortOrder       Int      @default(0) // æ˜¾ç¤ºæ’åº
  icon            String?  // å›¾æ ‡ï¼ˆå¯é€‰ï¼‰
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // å…³ç³»
  ticketIssueTypes TicketIssueType[]

  @@index([enabled, sortOrder])
  @@index([priorityWeight(desc)])
  @@map("IssueType")
}
```

### 2. æ–°å¢å·¥å•-é—®é¢˜ç±»å‹å…³è”è¡¨ `TicketIssueType`

```prisma
model TicketIssueType {
  id          String   @id @default(uuid())
  ticketId    String
  issueTypeId String
  createdAt   DateTime @default(now())

  // å…³ç³»
  ticket    Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  issueType IssueType @relation(fields: [issueTypeId], references: [id], onDelete: Cascade)

  @@unique([ticketId, issueTypeId]) // é˜²æ­¢é‡å¤å…³è”
  @@index([ticketId])
  @@index([issueTypeId])
  @@map("TicketIssueType")
}
```

### 3. ä¿®æ”¹ `Ticket` è¡¨

```prisma
model Ticket {
  // ... ç°æœ‰å­—æ®µ ...
  
  priorityScore   Int      @default(0) // æ–°å¢ï¼šä¼˜å…ˆçº§åˆ†æ•°ï¼ˆæ ¹æ®é—®é¢˜ç±»å‹è®¡ç®—ï¼‰
  
  // å…³ç³»
  // ... ç°æœ‰å…³ç³» ...
  ticketIssueTypes TicketIssueType[] // æ–°å¢ï¼šå…³è”çš„é—®é¢˜ç±»å‹
  
  @@index([priorityScore(desc)]) // æ–°å¢ï¼šä¼˜å…ˆçº§åˆ†æ•°ç´¢å¼•
}
```

### 4. ä¿®æ”¹ `TicketStatus` æšä¸¾

```prisma
enum TicketStatus {
  NEW           // æ–°å»ºï¼ˆä¿ç•™ï¼Œä½†ä¸ä½¿ç”¨ï¼‰
  IN_PROGRESS   // å¤„ç†ä¸­ï¼ˆç©å®¶åœ¨çº¿å’¨è¯¢ï¼‰
  WAITING       // å¾…å¤„ç†ï¼ˆç©å®¶æ–­å¼€è¿æ¥ï¼‰
  RESOLVED      // å·²è§£å†³ï¼ˆäººå·¥æ ‡è®°ï¼‰
  CLOSED        // å·²å…³é—­ï¼ˆä¿ç•™ï¼‰
}
```

---

## ğŸ“Š é¢„è®¾é—®é¢˜ç±»å‹æ•°æ®

### å¸¸è§é—®é¢˜ç±»å‹ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

| é—®é¢˜ç±»å‹ | ä¼˜å…ˆçº§æƒé‡ | æè¿° | æ’åº |
|---------|-----------|------|------|
| å……å€¼æœªåˆ°è´¦ | 95 | å……å€¼åé•¿æ—¶é—´æœªåˆ°è´¦ | 1 |
| è´¦å·è¢«ç›— | 90 | è´¦å·è¢«ä»–äººç™»å½•æˆ–ç›—ç”¨ | 2 |
| æ¸¸æˆæ— æ³•ç™»å½• | 85 | æ— æ³•æ­£å¸¸ç™»å½•æ¸¸æˆ | 3 |
| æ¸¸æˆé—ªé€€/å¡é¡¿ | 70 | æ¸¸æˆè¿è¡Œä¸ç¨³å®š | 4 |
| é“å…·ä¸¢å¤± | 75 | æ¸¸æˆå†…é“å…·æˆ–è£…å¤‡ä¸¢å¤± | 5 |
| æ´»åŠ¨å¥–åŠ±é—®é¢˜ | 60 | æ´»åŠ¨å¥–åŠ±æœªå‘æ”¾æˆ–é”™è¯¯ | 6 |
| æ¸¸æˆBUG | 65 | æ¸¸æˆåŠŸèƒ½å¼‚å¸¸æˆ–BUG | 7 |
| è´¦å·å°ç¦ç”³è¯‰ | 80 | è´¦å·è¢«å°ç¦ï¼Œç”³è¯·è§£å° | 8 |
| å®åè®¤è¯é—®é¢˜ | 55 | å®åè®¤è¯ç›¸å…³é—®é¢˜ | 9 |
| å¥½å‹/ç¤¾äº¤é—®é¢˜ | 40 | å¥½å‹ç³»ç»Ÿã€èŠå¤©ç­‰ç¤¾äº¤åŠŸèƒ½ | 10 |
| æ¸¸æˆç©æ³•å’¨è¯¢ | 30 | æ¸¸æˆç©æ³•ã€æ”»ç•¥å’¨è¯¢ | 11 |
| å…¶ä»–é—®é¢˜ | 50 | å…¶ä»–æœªåˆ†ç±»é—®é¢˜ | 12 |

---

## ğŸ”„ ä¼˜å…ˆçº§è®¡ç®—é€»è¾‘

### è®¡ç®—å…¬å¼

```typescript
// å·¥å•ä¼˜å…ˆçº§åˆ†æ•° = æ‰€é€‰é—®é¢˜ç±»å‹çš„æœ€é«˜æƒé‡ + (å…¶ä»–é—®é¢˜ç±»å‹æƒé‡ä¹‹å’Œ * 0.3)
priorityScore = maxWeight + (sumOfOtherWeights * 0.3)

// ç¤ºä¾‹ï¼š
// ç©å®¶é€‰æ‹©ï¼šå……å€¼æœªåˆ°è´¦(95) + è´¦å·è¢«ç›—(90) + æ¸¸æˆæ— æ³•ç™»å½•(85)
// priorityScore = 95 + ((90 + 85) * 0.3) = 95 + 52.5 = 147.5 â‰ˆ 148
```

### Priority æšä¸¾æ˜ å°„

```typescript
// æ ¹æ® priorityScore æ˜ å°„åˆ° Priority æšä¸¾
if (priorityScore >= 150) return Priority.URGENT;    // ç´§æ€¥
if (priorityScore >= 100) return Priority.HIGH;      // é«˜
if (priorityScore >= 60) return Priority.NORMAL;     // æ™®é€š
return Priority.LOW;                                  // ä½
```

---

## ğŸ”§ åç«¯å®ç°è¯¦ç»†æ–¹æ¡ˆ

### 1. åˆ›å»ºé—®é¢˜ç±»å‹æ¨¡å—

#### 1.1 æ–‡ä»¶ç»“æ„
```
backend/src/issue-type/
â”œâ”€â”€ issue-type.module.ts
â”œâ”€â”€ issue-type.controller.ts
â”œâ”€â”€ issue-type.service.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-issue-type.dto.ts
    â”œâ”€â”€ update-issue-type.dto.ts
    â””â”€â”€ issue-type-response.dto.ts
```

#### 1.2 DTO å®šä¹‰

**create-issue-type.dto.ts**
```typescript
import { IsString, IsInt, IsBoolean, IsOptional, Min, Max } from 'class-validator';

export class CreateIssueTypeDto {
  @IsString()
  name: string;

  @IsOptional()
  @IsString()
  description?: string;

  @IsInt()
  @Min(1)
  @Max(100)
  priorityWeight: number;

  @IsOptional()
  @IsBoolean()
  enabled?: boolean;

  @IsOptional()
  @IsInt()
  sortOrder?: number;

  @IsOptional()
  @IsString()
  icon?: string;
}
```

**update-issue-type.dto.ts**
```typescript
import { PartialType } from '@nestjs/mapped-types';
import { CreateIssueTypeDto } from './create-issue-type.dto';

export class UpdateIssueTypeDto extends PartialType(CreateIssueTypeDto) {}
```

**issue-type-response.dto.ts**
```typescript
export class IssueTypeResponseDto {
  id: string;
  name: string;
  description?: string;
  priorityWeight: number;
  enabled: boolean;
  sortOrder: number;
  icon?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

#### 1.3 Service å®ç°

**issue-type.service.ts**
```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { CreateIssueTypeDto } from './dto/create-issue-type.dto';
import { UpdateIssueTypeDto } from './dto/update-issue-type.dto';

@Injectable()
export class IssueTypeService {
  constructor(private prisma: PrismaService) {}

  // è·å–å¯ç”¨çš„é—®é¢˜ç±»å‹ï¼ˆç©å®¶ç«¯ï¼‰
  async findEnabled() {
    return this.prisma.issueType.findMany({
      where: {
        enabled: true,
        deletedAt: null,
      },
      orderBy: {
        sortOrder: 'asc',
      },
      select: {
        id: true,
        name: true,
        description: true,
        priorityWeight: true,
        icon: true,
        sortOrder: true,
      },
    });
  }

  // è·å–æ‰€æœ‰é—®é¢˜ç±»å‹ï¼ˆç®¡ç†ç«¯ï¼‰
  async findAll() {
    return this.prisma.issueType.findMany({
      where: {
        deletedAt: null,
      },
      orderBy: {
        sortOrder: 'asc',
      },
    });
  }

  // æ ¹æ® ID è·å–é—®é¢˜ç±»å‹
  async findOne(id: string) {
    const issueType = await this.prisma.issueType.findUnique({
      where: { id },
    });
    if (!issueType || issueType.deletedAt) {
      throw new NotFoundException('é—®é¢˜ç±»å‹ä¸å­˜åœ¨');
    }
    return issueType;
  }

  // åˆ›å»ºé—®é¢˜ç±»å‹
  async create(createDto: CreateIssueTypeDto) {
    return this.prisma.issueType.create({
      data: createDto,
    });
  }

  // æ›´æ–°é—®é¢˜ç±»å‹
  async update(id: string, updateDto: UpdateIssueTypeDto) {
    await this.findOne(id); // éªŒè¯å­˜åœ¨
    return this.prisma.issueType.update({
      where: { id },
      data: updateDto,
    });
  }

  // åˆ‡æ¢å¯ç”¨çŠ¶æ€
  async toggle(id: string) {
    const issueType = await this.findOne(id);
    return this.prisma.issueType.update({
      where: { id },
      data: { enabled: !issueType.enabled },
    });
  }

  // è½¯åˆ é™¤
  async remove(id: string) {
    await this.findOne(id);
    return this.prisma.issueType.update({
      where: { id },
      data: { deletedAt: new Date() },
    });
  }

  // æ‰¹é‡è·å–é—®é¢˜ç±»å‹ï¼ˆç”¨äºä¼˜å…ˆçº§è®¡ç®—ï¼‰
  async findByIds(ids: string[]) {
    return this.prisma.issueType.findMany({
      where: {
        id: { in: ids },
        enabled: true,
        deletedAt: null,
      },
    });
  }
}
```

#### 1.4 Controller å®ç°

**issue-type.controller.ts**
```typescript
import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Patch,
  Body,
  Param,
  UseGuards,
} from '@nestjs/common';
import { IssueTypeService } from './issue-type.service';
import { CreateIssueTypeDto } from './dto/create-issue-type.dto';
import { UpdateIssueTypeDto } from './dto/update-issue-type.dto';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
import { UserRole } from '@prisma/client';

@Controller('issue-types')
export class IssueTypeController {
  constructor(private readonly issueTypeService: IssueTypeService) {}

  // è·å–å¯ç”¨çš„é—®é¢˜ç±»å‹ï¼ˆå…¬å¼€æ¥å£ï¼Œç©å®¶ç«¯ä½¿ç”¨ï¼‰
  @Get()
  findEnabled() {
    return this.issueTypeService.findEnabled();
  }

  // è·å–æ‰€æœ‰é—®é¢˜ç±»å‹ï¼ˆç®¡ç†ç«¯ï¼‰
  @Get('all')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  findAll() {
    return this.issueTypeService.findAll();
  }

  // è·å–å•ä¸ªé—®é¢˜ç±»å‹
  @Get(':id')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  findOne(@Param('id') id: string) {
    return this.issueTypeService.findOne(id);
  }

  // åˆ›å»ºé—®é¢˜ç±»å‹
  @Post()
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  create(@Body() createDto: CreateIssueTypeDto) {
    return this.issueTypeService.create(createDto);
  }

  // æ›´æ–°é—®é¢˜ç±»å‹
  @Put(':id')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  update(@Param('id') id: string, @Body() updateDto: UpdateIssueTypeDto) {
    return this.issueTypeService.update(id, updateDto);
  }

  // åˆ‡æ¢å¯ç”¨çŠ¶æ€
  @Patch(':id/toggle')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  toggle(@Param('id') id: string) {
    return this.issueTypeService.toggle(id);
  }

  // åˆ é™¤é—®é¢˜ç±»å‹
  @Delete(':id')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  remove(@Param('id') id: string) {
    return this.issueTypeService.remove(id);
  }
}
```

#### 1.5 Module é…ç½®

**issue-type.module.ts**
```typescript
import { Module } from '@nestjs/common';
import { IssueTypeController } from './issue-type.controller';
import { IssueTypeService } from './issue-type.service';
import { PrismaService } from '../prisma/prisma.service';

@Module({
  controllers: [IssueTypeController],
  providers: [IssueTypeService, PrismaService],
  exports: [IssueTypeService],
})
export class IssueTypeModule {}
```

---

### 2. ä¿®æ”¹å·¥å•æ¨¡å—

#### 2.1 ä¿®æ”¹ DTO

**create-ticket.dto.ts**
```typescript
import {
  IsString,
  IsOptional,
  IsArray,
  IsUUID,
  IsDateString,
} from 'class-validator';

export class CreateTicketDto {
  @IsUUID()
  gameId: string;

  @IsOptional()
  @IsUUID()
  serverId?: string;

  @IsOptional()
  @IsString()
  serverName?: string;

  @IsString()
  playerIdOrName: string;

  @IsString()
  description: string;

  @IsOptional()
  @IsDateString()
  occurredAt?: string;

  @IsOptional()
  @IsString()
  paymentOrderNo?: string;

  // æ–°å¢ï¼šé—®é¢˜ç±»å‹ IDs
  @IsArray()
  @IsUUID('4', { each: true })
  issueTypeIds: string[];
}
```

#### 2.2 åˆ›å»ºä¼˜å…ˆçº§è®¡ç®—æœåŠ¡

**ticket-priority.service.ts**
```typescript
import { Injectable } from '@nestjs/common';
import { Priority } from '@prisma/client';
import { IssueTypeService } from '../issue-type/issue-type.service';

@Injectable()
export class TicketPriorityService {
  constructor(private issueTypeService: IssueTypeService) {}

  /**
   * è®¡ç®—å·¥å•ä¼˜å…ˆçº§
   * å…¬å¼ï¼špriorityScore = maxWeight + (sumOfOtherWeights * 0.3)
   */
  async calculatePriority(issueTypeIds: string[]): Promise<{
    priorityScore: number;
    priority: Priority;
  }> {
    if (!issueTypeIds || issueTypeIds.length === 0) {
      return {
        priorityScore: 50,
        priority: Priority.NORMAL,
      };
    }

    // è·å–æ‰€æœ‰é—®é¢˜ç±»å‹
    const issueTypes = await this.issueTypeService.findByIds(issueTypeIds);

    if (issueTypes.length === 0) {
      return {
        priorityScore: 50,
        priority: Priority.NORMAL,
      };
    }

    // è·å–æ‰€æœ‰æƒé‡
    const weights = issueTypes.map((type) => type.priorityWeight);

    // æ‰¾å‡ºæœ€é«˜æƒé‡
    const maxWeight = Math.max(...weights);

    // è®¡ç®—å…¶ä»–æƒé‡ä¹‹å’Œ
    const otherWeights = weights.filter((w) => w !== maxWeight);
    const sumOfOtherWeights = otherWeights.reduce((sum, w) => sum + w, 0);

    // è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°
    const priorityScore = Math.round(maxWeight + sumOfOtherWeights * 0.3);

    // æ˜ å°„åˆ° Priority æšä¸¾
    const priority = this.mapScoreToPriority(priorityScore);

    return { priorityScore, priority };
  }

  /**
   * å°†åˆ†æ•°æ˜ å°„åˆ°ä¼˜å…ˆçº§æšä¸¾
   */
  private mapScoreToPriority(score: number): Priority {
    if (score >= 150) return Priority.URGENT;
    if (score >= 100) return Priority.HIGH;
    if (score >= 60) return Priority.NORMAL;
    return Priority.LOW;
  }
}
```

#### 2.3 ä¿®æ”¹ Ticket Service

**ticket.service.ts** (å…³é”®ä¿®æ”¹éƒ¨åˆ†)
```typescript
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { TicketPriorityService } from './ticket-priority.service';
import { CreateTicketDto } from './dto/create-ticket.dto';
import { TicketStatus } from '@prisma/client';

@Injectable()
export class TicketService {
  constructor(
    private prisma: PrismaService,
    private priorityService: TicketPriorityService,
  ) {}

  async create(createDto: CreateTicketDto) {
    // 1. è®¡ç®—ä¼˜å…ˆçº§
    const { priorityScore, priority } =
      await this.priorityService.calculatePriority(createDto.issueTypeIds);

    // 2. ç”Ÿæˆå·¥å•å·
    const ticketNo = await this.generateTicketNo();

    // 3. ç”Ÿæˆ token
    const token = this.generateToken();

    // 4. åˆ›å»ºå·¥å•ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰
    const ticket = await this.prisma.$transaction(async (tx) => {
      // åˆ›å»ºå·¥å•
      const newTicket = await tx.ticket.create({
        data: {
          ticketNo,
          token,
          gameId: createDto.gameId,
          serverId: createDto.serverId,
          serverName: createDto.serverName,
          playerIdOrName: createDto.playerIdOrName,
          description: createDto.description,
          occurredAt: createDto.occurredAt
            ? new Date(createDto.occurredAt)
            : null,
          paymentOrderNo: createDto.paymentOrderNo,
          priority,
          priorityScore,
          status: TicketStatus.IN_PROGRESS, // åˆå§‹çŠ¶æ€ä¸ºå¤„ç†ä¸­
        },
      });

      // å…³è”é—®é¢˜ç±»å‹
      if (createDto.issueTypeIds && createDto.issueTypeIds.length > 0) {
        await tx.ticketIssueType.createMany({
          data: createDto.issueTypeIds.map((issueTypeId) => ({
            ticketId: newTicket.id,
            issueTypeId,
          })),
        });
      }

      return newTicket;
    });

    return ticket;
  }

  // æ›´æ–°å·¥å•çŠ¶æ€
  async updateStatus(ticketId: string, status: TicketStatus) {
    return this.prisma.ticket.update({
      where: { id: ticketId },
      data: {
        status,
        closedAt: status === TicketStatus.RESOLVED ? new Date() : null,
      },
    });
  }

  // è·å–å·¥å•è¯¦æƒ…ï¼ˆåŒ…å«é—®é¢˜ç±»å‹ï¼‰
  async findOne(id: string) {
    return this.prisma.ticket.findUnique({
      where: { id },
      include: {
        game: true,
        server: true,
        ticketIssueTypes: {
          include: {
            issueType: true,
          },
        },
        attachments: true,
      },
    });
  }

  // ç”Ÿæˆå·¥å•å·
  private async generateTicketNo(): Promise<string> {
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
    const count = await this.prisma.ticket.count({
      where: {
        createdAt: {
          gte: new Date(date.setHours(0, 0, 0, 0)),
        },
      },
    });
    return `TK${dateStr}${String(count + 1).padStart(4, '0')}`;
  }

  // ç”Ÿæˆ token
  private generateToken(): string {
    return Math.random().toString(36).substring(2, 15) +
      Math.random().toString(36).substring(2, 15);
  }
}
```

#### 2.4 ä¿®æ”¹ Ticket Controller

**ticket.controller.ts** (æ–°å¢æ¥å£)
```typescript
import { Controller, Patch, Param, UseGuards } from '@nestjs/common';
import { TicketService } from './ticket.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
import { UserRole, TicketStatus } from '@prisma/client';

@Controller('tickets')
export class TicketController {
  constructor(private readonly ticketService: TicketService) {}

  // ... ç°æœ‰æ¥å£ ...

  // æ ‡è®°å·¥å•ä¸ºå·²è§£å†³ï¼ˆäººå·¥æ“ä½œï¼‰
  @Patch(':id/resolve')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN, UserRole.AGENT)
  async resolveTicket(@Param('id') id: string) {
    return this.ticketService.updateStatus(id, TicketStatus.RESOLVED);
  }

  // æ ‡è®°å·¥å•ä¸ºå¾…å¤„ç†
  @Patch(':id/waiting')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN, UserRole.AGENT)
  async setWaiting(@Param('id') id: string) {
    return this.ticketService.updateStatus(id, TicketStatus.WAITING);
  }

  // æ ‡è®°å·¥å•ä¸ºå¤„ç†ä¸­
  @Patch(':id/in-progress')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN, UserRole.AGENT)
  async setInProgress(@Param('id') id: string) {
    return this.ticketService.updateStatus(id, TicketStatus.IN_PROGRESS);
  }
}
```

#### 2.5 æ›´æ–° Ticket Module

**ticket.module.ts**
```typescript
import { Module } from '@nestjs/common';
import { TicketController } from './ticket.controller';
import { TicketService } from './ticket.service';
import { TicketPriorityService } from './ticket-priority.service';
import { PrismaService } from '../prisma/prisma.service';
import { IssueTypeModule } from '../issue-type/issue-type.module';

@Module({
  imports: [IssueTypeModule], // å¯¼å…¥é—®é¢˜ç±»å‹æ¨¡å—
  controllers: [TicketController],
  providers: [TicketService, TicketPriorityService, PrismaService],
  exports: [TicketService],
})
export class TicketModule {}
```

---

### 3. WebSocket çŠ¶æ€ç®¡ç†

#### 3.1 ä¿®æ”¹ WebSocket Gateway

**websocket.gateway.ts** (å…³é”®ä¿®æ”¹éƒ¨åˆ†)
```typescript
import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  OnGatewayConnection,
  OnGatewayDisconnect,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { TicketService } from '../ticket/ticket.service';
import { SessionService } from '../session/session.service';
import { TicketStatus } from '@prisma/client';

@WebSocketGateway({
  cors: {
    origin: process.env.FRONTEND_URL?.split(',') || '*',
    credentials: true,
  },
})
export class WebsocketGateway
  implements OnGatewayConnection, OnGatewayDisconnect
{
  @WebSocketServer()
  server: Server;

  // å­˜å‚¨ç©å®¶è¿æ¥ä¿¡æ¯
  private playerConnections = new Map<string, string>(); // sessionId -> socketId

  constructor(
    private ticketService: TicketService,
    private sessionService: SessionService,
  ) {}

  // ç©å®¶è¿æ¥
  async handleConnection(client: Socket) {
    const sessionId = client.handshake.query.sessionId as string;
    if (sessionId) {
      this.playerConnections.set(sessionId, client.id);

      // è·å–ä¼šè¯ä¿¡æ¯
      const session = await this.sessionService.findOne(sessionId);
      if (session && session.ticketId) {
        // æ›´æ–°å·¥å•çŠ¶æ€ä¸ºå¤„ç†ä¸­
        await this.ticketService.updateStatus(
          session.ticketId,
          TicketStatus.IN_PROGRESS,
        );

        // é€šçŸ¥å®¢æœç«¯
        this.server.emit('ticket:status:changed', {
          ticketId: session.ticketId,
          status: TicketStatus.IN_PROGRESS,
        });
      }
    }
  }

  // ç©å®¶æ–­å¼€è¿æ¥
  async handleDisconnect(client: Socket) {
    const sessionId = client.handshake.query.sessionId as string;
    if (sessionId) {
      this.playerConnections.delete(sessionId);

      // è·å–ä¼šè¯ä¿¡æ¯
      const session = await this.sessionService.findOne(sessionId);
      if (session && session.ticketId) {
        // æ›´æ–°å·¥å•çŠ¶æ€ä¸ºå¾…å¤„ç†
        await this.ticketService.updateStatus(
          session.ticketId,
          TicketStatus.WAITING,
        );

        // é€šçŸ¥å®¢æœç«¯
        this.server.emit('ticket:status:changed', {
          ticketId: session.ticketId,
          status: TicketStatus.WAITING,
        });
      }
    }
  }

  // ç©å®¶ä¸»åŠ¨æ–­å¼€ï¼ˆç‚¹å‡»å…³é—­æŒ‰é’®ï¼‰
  @SubscribeMessage('player:leave')
  async handlePlayerLeave(client: Socket) {
    await this.handleDisconnect(client);
  }
}
```

---

### 4. æ›´æ–° App Module

**app.module.ts**
```typescript
import { Module } from '@nestjs/common';
// ... å…¶ä»–å¯¼å…¥
import { IssueTypeModule } from './issue-type/issue-type.module';

@Module({
  imports: [
    // ... ç°æœ‰æ¨¡å—
    IssueTypeModule, // æ–°å¢
    TicketModule,
    // ...
  ],
  // ...
})
export class AppModule {}
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. ç©å®¶ç«¯ - åé¦ˆè¡¨å•

**ä¿®æ”¹æ–‡ä»¶ï¼š** `player-app/src/pages/IntakeForm/index.tsx`

**æ–°å¢åŠŸèƒ½ï¼š**
```tsx
// 1. è·å–é—®é¢˜ç±»å‹åˆ—è¡¨
const [issueTypes, setIssueTypes] = useState<IssueType[]>([]);

useEffect(() => {
  fetchIssueTypes().then(setIssueTypes);
}, []);

// 2. æ·»åŠ é—®é¢˜ç±»å‹é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰
<Form.Item
  label="é—®é¢˜ç±»å‹"
  name="issueTypeIds"
  rules={[{ required: true, message: 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ç±»å‹' }]}
>
  <Checkbox.Group>
    {issueTypes.map(type => (
      <Checkbox key={type.id} value={type.id}>
        {type.icon && <span>{type.icon}</span>}
        {type.name}
      </Checkbox>
    ))}
  </Checkbox.Group>
</Form.Item>

// 3. æäº¤æ—¶åŒ…å«é—®é¢˜ç±»å‹
const ticketData = {
  // ... ç°æœ‰å­—æ®µ
  issueTypeIds: values.issueTypeIds, // æ–°å¢
};
```

### 2. ç®¡ç†ç«¯ - é—®é¢˜ç±»å‹ç®¡ç†

**æ–°å¢é¡µé¢ï¼š** `admin-portal/src/pages/IssueTypeManagement/index.tsx`

**åŠŸèƒ½ï¼š**
- é—®é¢˜ç±»å‹åˆ—è¡¨ï¼ˆè¡¨æ ¼ï¼‰
- æ·»åŠ /ç¼–è¾‘é—®é¢˜ç±»å‹ï¼ˆæ¨¡æ€æ¡†ï¼‰
- å¯ç”¨/ç¦ç”¨é—®é¢˜ç±»å‹ï¼ˆå¼€å…³ï¼‰
- æ‹–æ‹½æ’åºï¼ˆå¯é€‰ï¼‰
- åˆ é™¤é—®é¢˜ç±»å‹ï¼ˆç¡®è®¤ï¼‰

**è¡¨æ ¼åˆ—ï¼š**
- æ’åº
- é—®é¢˜ç±»å‹åç§°
- ä¼˜å…ˆçº§æƒé‡
- çŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- åˆ›å»ºæ—¶é—´
- æ“ä½œï¼ˆç¼–è¾‘ã€åˆ é™¤ï¼‰

### 3. ç®¡ç†ç«¯ - å·¥å•åˆ—è¡¨

**ä¿®æ”¹æ–‡ä»¶ï¼š** `admin-portal/src/pages/TicketList/index.tsx`

**æ–°å¢æ˜¾ç¤ºï¼š**
- å·¥å•çš„é—®é¢˜ç±»å‹æ ‡ç­¾
- ä¼˜å…ˆçº§åˆ†æ•°
- çŠ¶æ€å®æ—¶æ›´æ–°

---

## ğŸ“ æ•°æ®åº“è¿ç§»æ­¥éª¤

### 1. åˆ›å»ºè¿ç§»æ–‡ä»¶

```bash
npm run db:migrate -- --name add_issue_type_tables
```

### 2. è¿ç§»å†…å®¹

```sql
-- åˆ›å»ºé—®é¢˜ç±»å‹è¡¨
CREATE TABLE "IssueType" (
  "id" TEXT NOT NULL PRIMARY KEY,
  "name" TEXT NOT NULL,
  "description" TEXT,
  "priorityWeight" INTEGER NOT NULL DEFAULT 50,
  "enabled" BOOLEAN NOT NULL DEFAULT true,
  "sortOrder" INTEGER NOT NULL DEFAULT 0,
  "icon" TEXT,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  "deletedAt" TIMESTAMP(3)
);

-- åˆ›å»ºå·¥å•-é—®é¢˜ç±»å‹å…³è”è¡¨
CREATE TABLE "TicketIssueType" (
  "id" TEXT NOT NULL PRIMARY KEY,
  "ticketId" TEXT NOT NULL,
  "issueTypeId" TEXT NOT NULL,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT "TicketIssueType_ticketId_fkey" FOREIGN KEY ("ticketId") REFERENCES "Ticket"("id") ON DELETE CASCADE,
  CONSTRAINT "TicketIssueType_issueTypeId_fkey" FOREIGN KEY ("issueTypeId") REFERENCES "IssueType"("id") ON DELETE CASCADE
);

-- æ·»åŠ å”¯ä¸€çº¦æŸ
CREATE UNIQUE INDEX "TicketIssueType_ticketId_issueTypeId_key" ON "TicketIssueType"("ticketId", "issueTypeId");

-- æ·»åŠ ç´¢å¼•
CREATE INDEX "IssueType_enabled_sortOrder_idx" ON "IssueType"("enabled", "sortOrder");
CREATE INDEX "IssueType_priorityWeight_idx" ON "IssueType"("priorityWeight" DESC);
CREATE INDEX "TicketIssueType_ticketId_idx" ON "TicketIssueType"("ticketId");
CREATE INDEX "TicketIssueType_issueTypeId_idx" ON "TicketIssueType"("issueTypeId");

-- ä¿®æ”¹ Ticket è¡¨
ALTER TABLE "Ticket" ADD COLUMN "priorityScore" INTEGER NOT NULL DEFAULT 0;
CREATE INDEX "Ticket_priorityScore_idx" ON "Ticket"("priorityScore" DESC);
```

### 3. æ’å…¥é¢„è®¾æ•°æ®

```sql
-- æ’å…¥é¢„è®¾é—®é¢˜ç±»å‹
INSERT INTO "IssueType" ("id", "name", "description", "priorityWeight", "sortOrder", "icon", "createdAt", "updatedAt") VALUES
('issue-type-1', 'å……å€¼æœªåˆ°è´¦', 'å……å€¼åé•¿æ—¶é—´æœªåˆ°è´¦', 95, 1, 'ğŸ’°', NOW(), NOW()),
('issue-type-2', 'è´¦å·è¢«ç›—', 'è´¦å·è¢«ä»–äººç™»å½•æˆ–ç›—ç”¨', 90, 2, 'ğŸ”’', NOW(), NOW()),
('issue-type-3', 'æ¸¸æˆæ— æ³•ç™»å½•', 'æ— æ³•æ­£å¸¸ç™»å½•æ¸¸æˆ', 85, 3, 'ğŸš«', NOW(), NOW()),
('issue-type-4', 'é“å…·ä¸¢å¤±', 'æ¸¸æˆå†…é“å…·æˆ–è£…å¤‡ä¸¢å¤±', 75, 5, 'ğŸ“¦', NOW(), NOW()),
('issue-type-5', 'æ¸¸æˆé—ªé€€/å¡é¡¿', 'æ¸¸æˆè¿è¡Œä¸ç¨³å®š', 70, 4, 'âš ï¸', NOW(), NOW()),
('issue-type-6', 'æ¸¸æˆBUG', 'æ¸¸æˆåŠŸèƒ½å¼‚å¸¸æˆ–BUG', 65, 7, 'ğŸ›', NOW(), NOW()),
('issue-type-7', 'æ´»åŠ¨å¥–åŠ±é—®é¢˜', 'æ´»åŠ¨å¥–åŠ±æœªå‘æ”¾æˆ–é”™è¯¯', 60, 6, 'ğŸ', NOW(), NOW()),
('issue-type-8', 'è´¦å·å°ç¦ç”³è¯‰', 'è´¦å·è¢«å°ç¦ï¼Œç”³è¯·è§£å°', 80, 8, 'ğŸ”“', NOW(), NOW()),
('issue-type-9', 'å®åè®¤è¯é—®é¢˜', 'å®åè®¤è¯ç›¸å…³é—®é¢˜', 55, 9, 'ğŸ“', NOW(), NOW()),
('issue-type-10', 'å¥½å‹/ç¤¾äº¤é—®é¢˜', 'å¥½å‹ç³»ç»Ÿã€èŠå¤©ç­‰ç¤¾äº¤åŠŸèƒ½', 40, 10, 'ğŸ‘¥', NOW(), NOW()),
('issue-type-11', 'æ¸¸æˆç©æ³•å’¨è¯¢', 'æ¸¸æˆç©æ³•ã€æ”»ç•¥å’¨è¯¢', 30, 11, 'â“', NOW(), NOW()),
('issue-type-12', 'å…¶ä»–é—®é¢˜', 'å…¶ä»–æœªåˆ†ç±»é—®é¢˜', 50, 12, 'ğŸ“Œ', NOW(), NOW());
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

- ä¼˜å…ˆçº§è®¡ç®—é€»è¾‘æµ‹è¯•
- é—®é¢˜ç±»å‹ CRUD æµ‹è¯•
- å·¥å•çŠ¶æ€æ›´æ–°æµ‹è¯•

### 2. é›†æˆæµ‹è¯•

- åˆ›å»ºå·¥å•æ—¶å…³è”é—®é¢˜ç±»å‹
- ç©å®¶æ–­å¼€è¿æ¥æ—¶çŠ¶æ€æ›´æ–°
- å®¢æœæ ‡è®°å·¥å•å®Œæˆ

### 3. E2E æµ‹è¯•

- ç©å®¶æäº¤åé¦ˆæµç¨‹
- ç®¡ç†å‘˜ç®¡ç†é—®é¢˜ç±»å‹æµç¨‹
- å·¥å•ä¼˜å…ˆçº§æ’åºéªŒè¯

---

## ğŸ“… å®æ–½æ—¶é—´è¡¨

### é˜¶æ®µ 1ï¼šæ•°æ®åº“è®¾è®¡ï¼ˆ1 å°æ—¶ï¼‰
- âœ… è®¾è®¡æ•°æ®è¡¨ç»“æ„
- âœ… ç¼–å†™è¿ç§»æ–‡ä»¶
- âœ… å‡†å¤‡é¢„è®¾æ•°æ®

### é˜¶æ®µ 2ï¼šåç«¯å®ç°ï¼ˆ4-6 å°æ—¶ï¼‰
- åˆ›å»ºé—®é¢˜ç±»å‹æ¨¡å—ï¼ˆ2 å°æ—¶ï¼‰
- ä¿®æ”¹å·¥å•æ¨¡å—ï¼ˆ2 å°æ—¶ï¼‰
- å®ç°çŠ¶æ€ç®¡ç†ï¼ˆ1-2 å°æ—¶ï¼‰

### é˜¶æ®µ 3ï¼šå‰ç«¯å®ç°ï¼ˆ4-6 å°æ—¶ï¼‰
- ç©å®¶ç«¯è¡¨å•ä¿®æ”¹ï¼ˆ2 å°æ—¶ï¼‰
- ç®¡ç†ç«¯é—®é¢˜ç±»å‹ç®¡ç†ï¼ˆ2-3 å°æ—¶ï¼‰
- ç®¡ç†ç«¯å·¥å•åˆ—è¡¨ä¼˜åŒ–ï¼ˆ1 å°æ—¶ï¼‰

### é˜¶æ®µ 4ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3 å°æ—¶ï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆ1 å°æ—¶ï¼‰
- é›†æˆæµ‹è¯•ï¼ˆ1 å°æ—¶ï¼‰
- Bug ä¿®å¤å’Œä¼˜åŒ–ï¼ˆ1 å°æ—¶ï¼‰

**æ€»è®¡ï¼š11-16 å°æ—¶**

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è¿ç§»
- ç°æœ‰å·¥å•éœ€è¦è®¾ç½®é»˜è®¤é—®é¢˜ç±»å‹å—ï¼Ÿ
- å»ºè®®ï¼šä¸ºç°æœ‰å·¥å•è®¾ç½® `priorityScore = 50`ï¼ˆæ™®é€šä¼˜å…ˆçº§ï¼‰

### 2. å‘åå…¼å®¹
- æ—§ç‰ˆæœ¬çš„å·¥å•å¯èƒ½æ²¡æœ‰é—®é¢˜ç±»å‹
- éœ€è¦åœ¨æŸ¥è¯¢æ—¶å¤„ç†ç©ºå€¼æƒ…å†µ

### 3. æ€§èƒ½ä¼˜åŒ–
- é—®é¢˜ç±»å‹åˆ—è¡¨åº”è¯¥ç¼“å­˜ï¼ˆRedis æˆ–å†…å­˜ï¼‰
- ä¼˜å…ˆçº§è®¡ç®—åº”è¯¥å¼‚æ­¥å¤„ç†

### 4. æƒé™æ§åˆ¶
- åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç®¡ç†é—®é¢˜ç±»å‹
- å®¢æœå¯ä»¥æŸ¥çœ‹ä½†ä¸èƒ½ä¿®æ”¹

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **AI æ™ºèƒ½æ¨è**ï¼šæ ¹æ®é—®é¢˜æè¿°è‡ªåŠ¨æ¨èé—®é¢˜ç±»å‹
2. **ç»Ÿè®¡åˆ†æ**ï¼šé—®é¢˜ç±»å‹çš„åˆ†å¸ƒç»Ÿè®¡
3. **åŠ¨æ€æƒé‡**ï¼šæ ¹æ®å†å²æ•°æ®è‡ªåŠ¨è°ƒæ•´æƒé‡
4. **é—®é¢˜ç±»å‹åˆ†ç»„**ï¼šæ”¯æŒé—®é¢˜ç±»å‹çš„åˆ†ç±»ç®¡ç†

---

## âœ… ç¡®è®¤æ¸…å•

è¯·ç¡®è®¤ä»¥ä¸‹å†…å®¹åï¼Œæˆ‘å°†å¼€å§‹å®æ–½ï¼š

- [ ] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡æ˜¯å¦ç¬¦åˆéœ€æ±‚ï¼Ÿ
- [ ] é¢„è®¾çš„ 12 ç§é—®é¢˜ç±»å‹æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] ä¼˜å…ˆçº§è®¡ç®—å…¬å¼æ˜¯å¦åˆç†ï¼Ÿ
- [ ] å·¥å•çŠ¶æ€æµè½¬é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] å‰ç«¯è¡¨å•è®¾è®¡æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ä¸ºç°æœ‰å·¥å•è®¾ç½®é»˜è®¤é—®é¢˜ç±»å‹ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»–åŠŸèƒ½ï¼Ÿ

---

**è¯·ç¡®è®¤åï¼Œæˆ‘å°†å¼€å§‹å®æ–½æ­¤è®¡åˆ’ã€‚**


---

## ğŸ¨ å‰ç«¯å®ç°è¯¦ç»†æ–¹æ¡ˆ

### 1. ç©å®¶ç«¯ - API Service

#### 1.1 åˆ›å»ºé—®é¢˜ç±»å‹ Service

**player-app/src/services/issue-type.service.ts**
```typescript
import axios from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL;

export interface IssueType {
  id: string;
  name: string;
  description?: string;
  priorityWeight: number;
  icon?: string;
  sortOrder: number;
}

// è·å–å¯ç”¨çš„é—®é¢˜ç±»å‹åˆ—è¡¨
export const getEnabledIssueTypes = async (): Promise<IssueType[]> => {
  const response = await axios.get(`${API_BASE_URL}/issue-types`);
  return response.data;
};
```

#### 1.2 ä¿®æ”¹å·¥å• Service

**player-app/src/services/ticket.service.ts** (ä¿®æ”¹éƒ¨åˆ†)
```typescript
export interface CreateTicketDto {
  gameId: string;
  serverId?: string;
  serverName?: string;
  playerIdOrName: string;
  description: string;
  occurredAt?: string;
  paymentOrderNo?: string;
  issueTypeIds: string[]; // æ–°å¢
}

export const createTicket = async (data: CreateTicketDto) => {
  const response = await axios.post(`${API_BASE_URL}/tickets`, data);
  return response.data;
};
```

---

### 2. ç©å®¶ç«¯ - åé¦ˆè¡¨å•

#### 2.1 å®Œæ•´ä¿®æ”¹ IntakeForm

**player-app/src/pages/IntakeForm/index.tsx**
```typescript
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import {
  Form,
  Input,
  Button,
  Card,
  Upload,
  DatePicker,
  Typography,
  Checkbox,
  Space,
  Tag,
  Alert,
} from 'antd';
import { UploadOutlined } from '@ant-design/icons';
import type { UploadFile } from 'antd/es/upload/interface';
import type { CheckboxValueType } from 'antd/es/checkbox/Group';
import dayjs from 'dayjs';
import { createTicket, getTicketByToken } from '../../services/ticket.service';
import { getEnabledIssueTypes, type IssueType } from '../../services/issue-type.service';
import { uploadTicketAttachment } from '../../services/upload.service';
import { useTicketStore } from '../../stores/ticketStore';
import { createSession } from '../../services/session.service';
import { useMessage } from '../../hooks/useMessage';
import {
  validateDescription,
  validatePaymentOrderNo,
  validateFileSize,
  validateFileType,
} from '../../utils/validation';

const { TextArea } = Input;
const { Title, Text } = Typography;

const text = {
  pageTitle: 'é—®é¢˜åé¦ˆè¡¨å•',
  issueTypeLabel: 'é—®é¢˜ç±»å‹',
  issueTypePlaceholder: 'è¯·é€‰æ‹©æ‚¨é‡åˆ°çš„é—®é¢˜ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰',
  issueTypeRequired: 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé—®é¢˜ç±»å‹',
  descriptionLabel: 'é—®é¢˜æè¿°',
  descriptionPlaceholder: 'è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜...',
  occurredAtLabel: 'é—®é¢˜å‘ç”Ÿæ—¶é—´',
  occurredAtPlaceholder: 'è¯·é€‰æ‹©é—®é¢˜å‘ç”Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰',
  attachmentsLabel: 'é—®é¢˜æˆªå›¾',
  uploadText: 'ä¸Šä¼ ',
  uploadHint: 'æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤šå¯ä¸Šä¼  9 å¼ å›¾ç‰‡',
  paymentOrderLabel: 'æœ€è¿‘ä¸€æ¬¡å……å€¼è®¢å•å·',
  paymentOrderPlaceholder: 'è¯·è¾“å…¥å……å€¼è®¢å•å·ï¼ˆå¯é€‰ï¼Œç”¨äºæ ¸å¯¹ï¼‰',
  submitText: 'æäº¤å¹¶å¼€å§‹å’¨è¯¢',
  submitError: 'æäº¤åé¦ˆå¤±è´¥ï¼Œè¯·é‡è¯•',
  loadingIssueTypes: 'åŠ è½½é—®é¢˜ç±»å‹ä¸­...',
  loadIssueTypesError: 'åŠ è½½é—®é¢˜ç±»å‹å¤±è´¥',
};

const IntakeFormPage = () => {
  const navigate = useNavigate();
  const [form] = Form.useForm();
  const [fileList, setFileList] = useState<UploadFile[]>([]);
  const [loading, setLoading] = useState(false);
  const [issueTypes, setIssueTypes] = useState<IssueType[]>([]);
  const [loadingIssueTypes, setLoadingIssueTypes] = useState(true);
  const [selectedIssueTypes, setSelectedIssueTypes] = useState<CheckboxValueType[]>([]);
  const messageApi = useMessage();
  const { gameId, serverId, serverName, playerIdOrName, ticketToken, setTicket } =
    useTicketStore();
  const hasIdentity = Boolean(gameId && playerIdOrName);

  // åŠ è½½é—®é¢˜ç±»å‹
  useEffect(() => {
    const loadIssueTypes = async () => {
      try {
        setLoadingIssueTypes(true);
        const types = await getEnabledIssueTypes();
        setIssueTypes(types);
      } catch (error) {
        console.error('åŠ è½½é—®é¢˜ç±»å‹å¤±è´¥:', error);
        messageApi.error(text.loadIssueTypesError);
      } finally {
        setLoadingIssueTypes(false);
      }
    };

    if (hasIdentity) {
      loadIssueTypes();
    }
  }, [hasIdentity, messageApi]);

  useEffect(() => {
    if (!hasIdentity) {
      navigate('/identity-check', { replace: true });
    }
  }, [hasIdentity, navigate]);

  if (!hasIdentity) {
    return null;
  }

  // æäº¤è¡¨å•
  const handleSubmit = async (values: {
    issueTypeIds: string[];
    description: string;
    occurredAt?: dayjs.Dayjs;
    paymentOrderNo?: string;
  }) => {
    setLoading(true);
    try {
      const ticketData = {
        gameId: gameId!,
        serverId: serverId ?? undefined,
        serverName: serverName ?? undefined,
        playerIdOrName: playerIdOrName!,
        description: values.description,
        occurredAt: values.occurredAt?.toISOString(),
        paymentOrderNo: values.paymentOrderNo,
        issueTypeIds: values.issueTypeIds, // æ–°å¢
      };

      const ticket = await createTicket(ticketData);
      let resolvedTicketId =
        ticket.id || (ticket as { ticketId?: string }).ticketId;

      if (!resolvedTicketId && ticket.token) {
        try {
          const detail = await getTicketByToken(ticket.token);
          resolvedTicketId = detail.id;
        } catch (detailError) {
          console.error('æ ¹æ® token è·å–å·¥å•è¯¦æƒ…å¤±è´¥:', detailError);
        }
      }

      if (!resolvedTicketId) {
        throw new Error('å·¥å•åˆ›å»ºæˆåŠŸä½†æœªè¿”å› ID');
      }

      setTicket(resolvedTicketId, ticket.ticketNo, ticket.token);

      if (fileList.length > 0) {
        const uploadPromises = fileList.map((file) => {
          if (file.originFileObj) {
            return uploadTicketAttachment(file.originFileObj!, {
              ticketId: resolvedTicketId,
              ticketToken: ticket.token || ticketToken || undefined,
            });
          }
          return Promise.resolve(null);
        });
        await Promise.all(uploadPromises);
      }

      const session = await createSession({ ticketId: resolvedTicketId });
      navigate(`/chat/${session.id}`);
    } catch (error: unknown) {
      console.error('æäº¤è¡¨å•å¤±è´¥:', error);
      const apiError = error as {
        response?: { data?: { message?: string } };
      };
      messageApi.error(apiError.response?.data?.message || text.submitError);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="page-container">
      <div style={{ maxWidth: 800, width: '100%' }}>
        <Card className="page-card fade-in-up">
          <Title level={3} style={{ textAlign: 'center', marginBottom: '24px' }}>
            {text.pageTitle}
          </Title>

          <Form
            form={form}
            layout="vertical"
            onFinish={handleSubmit}
            autoComplete="off"
            className="enhanced-form"
          >
            {/* é—®é¢˜ç±»å‹é€‰æ‹© - æ–°å¢ */}
            <Form.Item
              label={
                <Space>
                  <span>{text.issueTypeLabel}</span>
                  <Text type="secondary" style={{ fontSize: '12px' }}>
                    ï¼ˆå¯å¤šé€‰ï¼‰
                  </Text>
                </Space>
              }
              name="issueTypeIds"
              rules={[
                {
                  required: true,
                  message: text.issueTypeRequired,
                },
              ]}
            >
              {loadingIssueTypes ? (
                <Alert message={text.loadingIssueTypes} type="info" />
              ) : (
                <Checkbox.Group
                  style={{ width: '100%' }}
                  onChange={(values) => setSelectedIssueTypes(values)}
                >
                  <Space direction="vertical" style={{ width: '100%' }} size="middle">
                    {issueTypes.map((type) => (
                      <Card
                        key={type.id}
                        size="small"
                        hoverable
                        style={{
                          borderColor: selectedIssueTypes.includes(type.id)
                            ? '#1890ff'
                            : undefined,
                        }}
                      >
                        <Checkbox value={type.id} style={{ width: '100%' }}>
                          <Space>
                            {type.icon && <span style={{ fontSize: '20px' }}>{type.icon}</span>}
                            <div>
                              <div style={{ fontWeight: 500 }}>{type.name}</div>
                              {type.description && (
                                <Text type="secondary" style={{ fontSize: '12px' }}>
                                  {type.description}
                                </Text>
                              )}
                            </div>
                          </Space>
                        </Checkbox>
                      </Card>
                    ))}
                  </Space>
                </Checkbox.Group>
              )}
            </Form.Item>

            {/* é—®é¢˜æè¿° */}
            <Form.Item
              label={text.descriptionLabel}
              name="description"
              rules={[{ validator: validateDescription }]}
            >
              <TextArea
                rows={6}
                placeholder={text.descriptionPlaceholder}
                maxLength={2000}
                showCount
              />
            </Form.Item>

            {/* é—®é¢˜å‘ç”Ÿæ—¶é—´ */}
            <Form.Item label={text.occurredAtLabel} name="occurredAt">
              <DatePicker
                showTime
                style={{ width: '100%' }}
                placeholder={text.occurredAtPlaceholder}
              />
            </Form.Item>

            {/* é—®é¢˜æˆªå›¾ */}
            <Form.Item label={text.attachmentsLabel}>
              <Upload
                listType="picture-card"
                fileList={fileList}
                onChange={({ fileList: newFileList }) => {
                  setFileList(newFileList.slice(0, 9));
                }}
                beforeUpload={(file) => {
                  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                  try {
                    validateFileType(file, allowedTypes);
                    validateFileSize(file, 10);
                    return false;
                  } catch (error: unknown) {
                    if (error instanceof Error) {
                      messageApi.error(error.message);
                    } else {
                      messageApi.error('æ–‡ä»¶æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                    return Upload.LIST_IGNORE;
                  }
                }}
                accept="image/jpeg,image/png,image/gif"
                maxCount={9}
              >
                {fileList.length < 9 && (
                  <div>
                    <UploadOutlined />
                    <div style={{ marginTop: 8 }}>{text.uploadText}</div>
                  </div>
                )}
              </Upload>
              <div style={{ color: '#999', fontSize: '12px', marginTop: '8px' }}>
                {text.uploadHint}
              </div>
            </Form.Item>

            {/* å……å€¼è®¢å•å· */}
            <Form.Item
              label={text.paymentOrderLabel}
              name="paymentOrderNo"
              rules={[{ validator: validatePaymentOrderNo }]}
            >
              <Input placeholder={text.paymentOrderPlaceholder} />
            </Form.Item>

            {/* æäº¤æŒ‰é’® */}
            <Form.Item>
              <Button
                type="primary"
                htmlType="submit"
                block
                size="large"
                loading={loading}
                disabled={loadingIssueTypes}
              >
                {text.submitText}
              </Button>
            </Form.Item>
          </Form>
        </Card>
      </div>
    </div>
  );
};

export default IntakeFormPage;
```



---

### 3. ç®¡ç†ç«¯ - API Service

#### 3.1 åˆ›å»ºé—®é¢˜ç±»å‹ Service

**admin-portal/src/services/issue-type.service.ts**
```typescript
import axios from 'axios';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL;

export interface IssueType {
  id: string;
  name: string;
  description?: string;
  priorityWeight: number;
  enabled: boolean;
  sortOrder: number;
  icon?: string;
  createdAt: string;
  updatedAt: string;
}

export interface CreateIssueTypeDto {
  name: string;
  description?: string;
  priorityWeight: number;
  enabled?: boolean;
  sortOrder?: number;
  icon?: string;
}

export interface UpdateIssueTypeDto extends Partial<CreateIssueTypeDto> {}

// è·å–æ‰€æœ‰é—®é¢˜ç±»å‹
export const getAllIssueTypes = async (): Promise<IssueType[]> => {
  const response = await axios.get(`${API_BASE_URL}/issue-types/all`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`,
    },
  });
  return response.data;
};

// è·å–å•ä¸ªé—®é¢˜ç±»å‹
export const getIssueType = async (id: string): Promise<IssueType> => {
  const response = await axios.get(`${API_BASE_URL}/issue-types/${id}`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`,
    },
  });
  return response.data;
};

// åˆ›å»ºé—®é¢˜ç±»å‹
export const createIssueType = async (data: CreateIssueTypeDto): Promise<IssueType> => {
  const response = await axios.post(`${API_BASE_URL}/issue-types`, data, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`,
    },
  });
  return response.data;
};

// æ›´æ–°é—®é¢˜ç±»å‹
export const updateIssueType = async (
  id: string,
  data: UpdateIssueTypeDto,
): Promise<IssueType> => {
  const response = await axios.put(`${API_BASE_URL}/issue-types/${id}`, data, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`,
    },
  });
  return response.data;
};

// åˆ‡æ¢å¯ç”¨çŠ¶æ€
export const toggleIssueType = async (id: string): Promise<IssueType> => {
  const response = await axios.patch(
    `${API_BASE_URL}/issue-types/${id}/toggle`,
    {},
    {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    },
  );
  return response.data;
};

// åˆ é™¤é—®é¢˜ç±»å‹
export const deleteIssueType = async (id: string): Promise<void> => {
  await axios.delete(`${API_BASE_URL}/issue-types/${id}`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem('token')}`,
    },
  });
};
```

#### 3.2 ä¿®æ”¹å·¥å• Service

**admin-portal/src/services/ticket.service.ts** (æ–°å¢éƒ¨åˆ†)
```typescript
// æ ‡è®°å·¥å•ä¸ºå·²è§£å†³
export const resolveTicket = async (ticketId: string) => {
  const response = await axios.patch(
    `${API_BASE_URL}/tickets/${ticketId}/resolve`,
    {},
    {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    },
  );
  return response.data;
};

// æ ‡è®°å·¥å•ä¸ºå¾…å¤„ç†
export const setTicketWaiting = async (ticketId: string) => {
  const response = await axios.patch(
    `${API_BASE_URL}/tickets/${ticketId}/waiting`,
    {},
    {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    },
  );
  return response.data;
};

// æ ‡è®°å·¥å•ä¸ºå¤„ç†ä¸­
export const setTicketInProgress = async (ticketId: string) => {
  const response = await axios.patch(
    `${API_BASE_URL}/tickets/${ticketId}/in-progress`,
    {},
    {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    },
  );
  return response.data;
};
```

---

### 4. ç®¡ç†ç«¯ - é—®é¢˜ç±»å‹ç®¡ç†é¡µé¢

**admin-portal/src/pages/IssueTypeManagement/index.tsx**
```typescript
import { useState, useEffect } from 'react';
import {
  Card,
  Table,
  Button,
  Space,
  Modal,
  Form,
  Input,
  InputNumber,
  Switch,
  message,
  Popconfirm,
  Tag,
} from '@ant-design/pro-components';
import { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import {
  getAllIssueTypes,
  createIssueType,
  updateIssueType,
  toggleIssueType,
  deleteIssueType,
  type IssueType,
  type CreateIssueTypeDto,
} from '../../services/issue-type.service';

const IssueTypeManagement = () => {
  const [issueTypes, setIssueTypes] = useState<IssueType[]>([]);
  const [loading, setLoading] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [editingType, setEditingType] = useState<IssueType | null>(null);
  const [form] = Form.useForm();

  // åŠ è½½é—®é¢˜ç±»å‹åˆ—è¡¨
  const loadIssueTypes = async () => {
    setLoading(true);
    try {
      const data = await getAllIssueTypes();
      setIssueTypes(data);
    } catch (error) {
      message.error('åŠ è½½é—®é¢˜ç±»å‹å¤±è´¥');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadIssueTypes();
  }, []);

  // æ‰“å¼€æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡†
  const handleOpenModal = (type?: IssueType) => {
    if (type) {
      setEditingType(type);
      form.setFieldsValue(type);
    } else {
      setEditingType(null);
      form.resetFields();
    }
    setModalVisible(true);
  };

  // å…³é—­æ¨¡æ€æ¡†
  const handleCloseModal = () => {
    setModalVisible(false);
    setEditingType(null);
    form.resetFields();
  };

  // æäº¤è¡¨å•
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      const data: CreateIssueTypeDto = {
        name: values.name,
        description: values.description,
        priorityWeight: values.priorityWeight,
        enabled: values.enabled ?? true,
        sortOrder: values.sortOrder ?? 0,
        icon: values.icon,
      };

      if (editingType) {
        await updateIssueType(editingType.id, data);
        message.success('æ›´æ–°æˆåŠŸ');
      } else {
        await createIssueType(data);
        message.success('åˆ›å»ºæˆåŠŸ');
      }

      handleCloseModal();
      loadIssueTypes();
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥');
      console.error(error);
    }
  };

  // åˆ‡æ¢å¯ç”¨çŠ¶æ€
  const handleToggle = async (id: string) => {
    try {
      await toggleIssueType(id);
      message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
      loadIssueTypes();
    } catch (error) {
      message.error('çŠ¶æ€æ›´æ–°å¤±è´¥');
      console.error(error);
    }
  };

  // åˆ é™¤é—®é¢˜ç±»å‹
  const handleDelete = async (id: string) => {
    try {
      await deleteIssueType(id);
      message.success('åˆ é™¤æˆåŠŸ');
      loadIssueTypes();
    } catch (error) {
      message.error('åˆ é™¤å¤±è´¥');
      console.error(error);
    }
  };

  // è¡¨æ ¼åˆ—å®šä¹‰
  const columns: ColumnsType<IssueType> = [
    {
      title: 'æ’åº',
      dataIndex: 'sortOrder',
      key: 'sortOrder',
      width: 80,
      sorter: (a, b) => a.sortOrder - b.sortOrder,
    },
    {
      title: 'å›¾æ ‡',
      dataIndex: 'icon',
      key: 'icon',
      width: 80,
      render: (icon) => (icon ? <span style={{ fontSize: '24px' }}>{icon}</span> : '-'),
    },
    {
      title: 'é—®é¢˜ç±»å‹',
      dataIndex: 'name',
      key: 'name',
    },
    {
      title: 'æè¿°',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
    },
    {
      title: 'ä¼˜å…ˆçº§æƒé‡',
      dataIndex: 'priorityWeight',
      key: 'priorityWeight',
      width: 120,
      sorter: (a, b) => a.priorityWeight - b.priorityWeight,
      render: (weight) => (
        <Tag color={weight >= 80 ? 'red' : weight >= 60 ? 'orange' : 'blue'}>
          {weight}
        </Tag>
      ),
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'enabled',
      key: 'enabled',
      width: 100,
      render: (enabled, record) => (
        <Switch
          checked={enabled}
          onChange={() => handleToggle(record.id)}
          checkedChildren="å¯ç”¨"
          unCheckedChildren="ç¦ç”¨"
        />
      ),
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createdAt',
      key: 'createdAt',
      width: 180,
      render: (date) => new Date(date).toLocaleString('zh-CN'),
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 150,
      render: (_, record) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => handleOpenModal(record)}
          >
            ç¼–è¾‘
          </Button>
          <Popconfirm
            title="ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜ç±»å‹å—ï¼Ÿ"
            onConfirm={() => handleDelete(record.id)}
            okText="ç¡®å®š"
            cancelText="å–æ¶ˆ"
          >
            <Button type="link" danger icon={<DeleteOutlined />}>
              åˆ é™¤
            </Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div style={{ padding: '24px' }}>
      <Card
        title="é—®é¢˜ç±»å‹ç®¡ç†"
        extra={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => handleOpenModal()}
          >
            æ–°å¢é—®é¢˜ç±»å‹
          </Button>
        }
      >
        <Table
          columns={columns}
          dataSource={issueTypes}
          rowKey="id"
          loading={loading}
          pagination={{
            pageSize: 20,
            showSizeChanger: true,
            showTotal: (total) => `å…± ${total} æ¡`,
          }}
        />
      </Card>

      {/* æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        title={editingType ? 'ç¼–è¾‘é—®é¢˜ç±»å‹' : 'æ–°å¢é—®é¢˜ç±»å‹'}
        open={modalVisible}
        onOk={handleSubmit}
        onCancel={handleCloseModal}
        width={600}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            label="é—®é¢˜ç±»å‹åç§°"
            name="name"
            rules={[{ required: true, message: 'è¯·è¾“å…¥é—®é¢˜ç±»å‹åç§°' }]}
          >
            <Input placeholder="å¦‚ï¼šå……å€¼æœªåˆ°è´¦" />
          </Form.Item>

          <Form.Item label="æè¿°" name="description">
            <Input.TextArea rows={3} placeholder="é—®é¢˜ç±»å‹çš„è¯¦ç»†æè¿°" />
          </Form.Item>

          <Form.Item
            label="ä¼˜å…ˆçº§æƒé‡"
            name="priorityWeight"
            rules={[{ required: true, message: 'è¯·è¾“å…¥ä¼˜å…ˆçº§æƒé‡' }]}
            tooltip="æƒé‡èŒƒå›´ 1-100ï¼Œæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜"
          >
            <InputNumber min={1} max={100} style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item
            label="æ’åº"
            name="sortOrder"
            tooltip="æ•°å€¼è¶Šå°è¶Šé å‰"
          >
            <InputNumber min={0} style={{ width: '100%' }} />
          </Form.Item>

          <Form.Item
            label="å›¾æ ‡"
            name="icon"
            tooltip="å¯ä»¥ä½¿ç”¨ Emoji è¡¨æƒ…"
          >
            <Input placeholder="å¦‚ï¼šğŸ’°" />
          </Form.Item>

          <Form.Item label="å¯ç”¨çŠ¶æ€" name="enabled" valuePropName="checked">
            <Switch checkedChildren="å¯ç”¨" unCheckedChildren="ç¦ç”¨" />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default IssueTypeManagement;
```



---

### 5. ç®¡ç†ç«¯ - å·¥å•åˆ—è¡¨ä¼˜åŒ–

#### 5.1 ä¿®æ”¹å·¥å•åˆ—è¡¨é¡µé¢

**admin-portal/src/pages/TicketList/index.tsx** (å…³é”®ä¿®æ”¹éƒ¨åˆ†)
```typescript
import { Tag, Space, Badge } from 'antd';
import type { ColumnsType } from 'antd/es/table';

// å·¥å•çŠ¶æ€æ˜ å°„
const statusMap = {
  NEW: { text: 'æ–°å»º', color: 'default' },
  IN_PROGRESS: { text: 'å¤„ç†ä¸­', color: 'processing' },
  WAITING: { text: 'å¾…å¤„ç†', color: 'warning' },
  RESOLVED: { text: 'å·²è§£å†³', color: 'success' },
  CLOSED: { text: 'å·²å…³é—­', color: 'default' },
};

// ä¼˜å…ˆçº§æ˜ å°„
const priorityMap = {
  LOW: { text: 'ä½', color: 'default' },
  NORMAL: { text: 'æ™®é€š', color: 'blue' },
  HIGH: { text: 'é«˜', color: 'orange' },
  URGENT: { text: 'ç´§æ€¥', color: 'red' },
};

// è¡¨æ ¼åˆ—å®šä¹‰ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
const columns: ColumnsType<Ticket> = [
  // ... ç°æœ‰åˆ— ...
  
  {
    title: 'é—®é¢˜ç±»å‹',
    dataIndex: 'ticketIssueTypes',
    key: 'issueTypes',
    width: 200,
    render: (ticketIssueTypes) => (
      <Space wrap>
        {ticketIssueTypes?.map((item: any) => (
          <Tag key={item.id} icon={item.issueType.icon}>
            {item.issueType.name}
          </Tag>
        ))}
      </Space>
    ),
  },
  
  {
    title: 'ä¼˜å…ˆçº§',
    dataIndex: 'priority',
    key: 'priority',
    width: 100,
    render: (priority, record) => (
      <Space direction="vertical" size="small">
        <Tag color={priorityMap[priority]?.color}>
          {priorityMap[priority]?.text}
        </Tag>
        <span style={{ fontSize: '12px', color: '#999' }}>
          åˆ†æ•°: {record.priorityScore}
        </span>
      </Space>
    ),
    sorter: (a, b) => a.priorityScore - b.priorityScore,
  },
  
  {
    title: 'çŠ¶æ€',
    dataIndex: 'status',
    key: 'status',
    width: 120,
    render: (status) => (
      <Badge
        status={statusMap[status]?.color as any}
        text={statusMap[status]?.text}
      />
    ),
    filters: [
      { text: 'å¤„ç†ä¸­', value: 'IN_PROGRESS' },
      { text: 'å¾…å¤„ç†', value: 'WAITING' },
      { text: 'å·²è§£å†³', value: 'RESOLVED' },
      { text: 'å·²å…³é—­', value: 'CLOSED' },
    ],
    onFilter: (value, record) => record.status === value,
  },
  
  // ... å…¶ä»–åˆ— ...
];
```

#### 5.2 æ·»åŠ  WebSocket å®æ—¶æ›´æ–°

**admin-portal/src/pages/TicketList/index.tsx** (WebSocket éƒ¨åˆ†)
```typescript
import { useEffect } from 'react';
import { io, Socket } from 'socket.io-client';

const TicketList = () => {
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [socket, setSocket] = useState<Socket | null>(null);

  // åˆå§‹åŒ– WebSocket
  useEffect(() => {
    const WS_URL = import.meta.env.VITE_WS_URL;
    const newSocket = io(WS_URL, {
      auth: {
        token: localStorage.getItem('token'),
      },
    });

    setSocket(newSocket);

    // ç›‘å¬å·¥å•çŠ¶æ€å˜åŒ–
    newSocket.on('ticket:status:changed', (data: { ticketId: string; status: string }) => {
      setTickets((prevTickets) =>
        prevTickets.map((ticket) =>
          ticket.id === data.ticketId
            ? { ...ticket, status: data.status }
            : ticket
        )
      );
    });

    return () => {
      newSocket.close();
    };
  }, []);

  // ... å…¶ä»–ä»£ç  ...
};
```

---

### 6. ç®¡ç†ç«¯ - å·¥å•è¯¦æƒ…é¡µä¼˜åŒ–

**admin-portal/src/pages/TicketDetail/index.tsx** (æ–°å¢éƒ¨åˆ†)
```typescript
import { Button, Space, Modal, message } from 'antd';
import { CheckOutlined, ClockCircleOutlined } from '@ant-design/icons';
import { resolveTicket, setTicketWaiting } from '../../services/ticket.service';

const TicketDetail = () => {
  const [ticket, setTicket] = useState<Ticket | null>(null);

  // æ ‡è®°ä¸ºå·²è§£å†³
  const handleResolve = () => {
    Modal.confirm({
      title: 'ç¡®è®¤æ“ä½œ',
      content: 'ç¡®å®šè¦å°†æ­¤å·¥å•æ ‡è®°ä¸ºå·²è§£å†³å—ï¼Ÿ',
      onOk: async () => {
        try {
          await resolveTicket(ticket!.id);
          message.success('å·¥å•å·²æ ‡è®°ä¸ºå·²è§£å†³');
          // åˆ·æ–°å·¥å•è¯¦æƒ…
          loadTicketDetail();
        } catch (error) {
          message.error('æ“ä½œå¤±è´¥');
          console.error(error);
        }
      },
    });
  };

  // æ ‡è®°ä¸ºå¾…å¤„ç†
  const handleSetWaiting = async () => {
    try {
      await setTicketWaiting(ticket!.id);
      message.success('å·¥å•å·²æ ‡è®°ä¸ºå¾…å¤„ç†');
      loadTicketDetail();
    } catch (error) {
      message.error('æ“ä½œå¤±è´¥');
      console.error(error);
    }
  };

  return (
    <div>
      {/* å·¥å•è¯¦æƒ…å†…å®¹ */}
      
      {/* æ“ä½œæŒ‰é’® */}
      <Space style={{ marginTop: '16px' }}>
        {ticket?.status === 'IN_PROGRESS' && (
          <Button
            type="primary"
            icon={<CheckOutlined />}
            onClick={handleResolve}
          >
            æ ‡è®°ä¸ºå·²è§£å†³
          </Button>
        )}
        
        {ticket?.status === 'IN_PROGRESS' && (
          <Button
            icon={<ClockCircleOutlined />}
            onClick={handleSetWaiting}
          >
            æ ‡è®°ä¸ºå¾…å¤„ç†
          </Button>
        )}
      </Space>
      
      {/* é—®é¢˜ç±»å‹æ˜¾ç¤º */}
      <div style={{ marginTop: '16px' }}>
        <h4>é—®é¢˜ç±»å‹ï¼š</h4>
        <Space wrap>
          {ticket?.ticketIssueTypes?.map((item: any) => (
            <Tag key={item.id} icon={item.issueType.icon} color="blue">
              {item.issueType.name}
            </Tag>
          ))}
        </Space>
      </div>
      
      {/* ä¼˜å…ˆçº§ä¿¡æ¯ */}
      <div style={{ marginTop: '16px' }}>
        <h4>ä¼˜å…ˆçº§ä¿¡æ¯ï¼š</h4>
        <Space>
          <Tag color={priorityMap[ticket?.priority]?.color}>
            {priorityMap[ticket?.priority]?.text}
          </Tag>
          <span>ä¼˜å…ˆçº§åˆ†æ•°: {ticket?.priorityScore}</span>
        </Space>
      </div>
    </div>
  );
};
```

---

### 7. è·¯ç”±é…ç½®

#### 7.1 ç®¡ç†ç«¯è·¯ç”±

**admin-portal/src/routes/index.tsx** (æ–°å¢è·¯ç”±)
```typescript
import IssueTypeManagement from '../pages/IssueTypeManagement';

const routes = [
  // ... ç°æœ‰è·¯ç”± ...
  
  {
    path: '/issue-types',
    element: <IssueTypeManagement />,
    meta: {
      title: 'é—®é¢˜ç±»å‹ç®¡ç†',
      requiresAuth: true,
      roles: ['ADMIN'],
    },
  },
  
  // ... å…¶ä»–è·¯ç”± ...
];
```

#### 7.2 ç®¡ç†ç«¯èœå•é…ç½®

**admin-portal/src/layouts/MainLayout.tsx** (æ–°å¢èœå•é¡¹)
```typescript
import { SettingOutlined } from '@ant-design/icons';

const menuItems = [
  // ... ç°æœ‰èœå• ...
  
  {
    key: '/issue-types',
    icon: <SettingOutlined />,
    label: 'é—®é¢˜ç±»å‹ç®¡ç†',
  },
  
  // ... å…¶ä»–èœå• ...
];
```

---

## ğŸ“¦ å®Œæ•´æ–‡ä»¶æ¸…å•

### åç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶

**æ–°å¢æ–‡ä»¶ï¼š**
1. `backend/src/issue-type/issue-type.module.ts`
2. `backend/src/issue-type/issue-type.controller.ts`
3. `backend/src/issue-type/issue-type.service.ts`
4. `backend/src/issue-type/dto/create-issue-type.dto.ts`
5. `backend/src/issue-type/dto/update-issue-type.dto.ts`
6. `backend/src/issue-type/dto/issue-type-response.dto.ts`
7. `backend/src/ticket/ticket-priority.service.ts`

**ä¿®æ”¹æ–‡ä»¶ï¼š**
1. `backend/prisma/schema.prisma` - æ·»åŠ  IssueType å’Œ TicketIssueType è¡¨
2. `backend/src/ticket/dto/create-ticket.dto.ts` - æ·»åŠ  issueTypeIds å­—æ®µ
3. `backend/src/ticket/ticket.service.ts` - æ·»åŠ ä¼˜å…ˆçº§è®¡ç®—é€»è¾‘
4. `backend/src/ticket/ticket.controller.ts` - æ·»åŠ çŠ¶æ€ç®¡ç†æ¥å£
5. `backend/src/ticket/ticket.module.ts` - å¯¼å…¥ IssueTypeModule
6. `backend/src/websocket/websocket.gateway.ts` - æ·»åŠ çŠ¶æ€ç›‘å¬
7. `backend/src/app.module.ts` - å¯¼å…¥ IssueTypeModule

---

### å‰ç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶

**ç©å®¶ç«¯æ–°å¢æ–‡ä»¶ï¼š**
1. `player-app/src/services/issue-type.service.ts`

**ç©å®¶ç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
1. `player-app/src/services/ticket.service.ts` - æ·»åŠ  issueTypeIds å­—æ®µ
2. `player-app/src/pages/IntakeForm/index.tsx` - æ·»åŠ é—®é¢˜ç±»å‹é€‰æ‹©

**ç®¡ç†ç«¯æ–°å¢æ–‡ä»¶ï¼š**
1. `admin-portal/src/services/issue-type.service.ts`
2. `admin-portal/src/pages/IssueTypeManagement/index.tsx`

**ç®¡ç†ç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
1. `admin-portal/src/services/ticket.service.ts` - æ·»åŠ çŠ¶æ€ç®¡ç†æ¥å£
2. `admin-portal/src/pages/TicketList/index.tsx` - æ˜¾ç¤ºé—®é¢˜ç±»å‹å’Œå®æ—¶æ›´æ–°
3. `admin-portal/src/pages/TicketDetail/index.tsx` - æ·»åŠ çŠ¶æ€æ“ä½œæŒ‰é’®
4. `admin-portal/src/routes/index.tsx` - æ·»åŠ é—®é¢˜ç±»å‹ç®¡ç†è·¯ç”±
5. `admin-portal/src/layouts/MainLayout.tsx` - æ·»åŠ èœå•é¡¹

---

## âœ… å®Œæ•´ç¡®è®¤æ¸…å•

è¯·ç¡®è®¤ä»¥ä¸‹æ‰€æœ‰å†…å®¹ï¼š

### æ•°æ®åº“è®¾è®¡
- [ ] IssueType è¡¨ç»“æ„æ˜¯å¦åˆç†ï¼Ÿ
- [ ] TicketIssueType å…³è”è¡¨æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] Ticket è¡¨æ–°å¢ priorityScore å­—æ®µæ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] é¢„è®¾çš„ 12 ç§é—®é¢˜ç±»å‹æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ

### åç«¯å®ç°
- [ ] é—®é¢˜ç±»å‹ CRUD æ¥å£æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] ä¼˜å…ˆçº§è®¡ç®—å…¬å¼æ˜¯å¦åˆç†ï¼Ÿ
- [ ] å·¥å•çŠ¶æ€æµè½¬é€»è¾‘æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] WebSocket å®æ—¶æ›´æ–°æ˜¯å¦éœ€è¦ï¼Ÿ
- [ ] æƒé™æ§åˆ¶æ˜¯å¦åˆç†ï¼Ÿ

### å‰ç«¯å®ç°
- [ ] ç©å®¶ç«¯è¡¨å•è®¾è®¡æ˜¯å¦å‹å¥½ï¼Ÿ
- [ ] é—®é¢˜ç±»å‹å¤šé€‰äº¤äº’æ˜¯å¦æ¸…æ™°ï¼Ÿ
- [ ] ç®¡ç†ç«¯é—®é¢˜ç±»å‹ç®¡ç†åŠŸèƒ½æ˜¯å¦å®Œæ•´ï¼Ÿ
- [ ] å·¥å•åˆ—è¡¨æ˜¾ç¤ºæ˜¯å¦åˆç†ï¼Ÿ
- [ ] å®æ—¶çŠ¶æ€æ›´æ–°æ˜¯å¦éœ€è¦ï¼Ÿ

### å…¶ä»–
- [ ] ç°æœ‰å·¥å•å¦‚ä½•å¤„ç†ï¼Ÿï¼ˆå»ºè®®è®¾ç½®é»˜è®¤ priorityScore = 50ï¼‰
- [ ] æ˜¯å¦éœ€è¦æ•°æ®è¿ç§»è„šæœ¬ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ å•å…ƒæµ‹è¯•ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ·»åŠ  E2E æµ‹è¯•ï¼Ÿ

---

**è¯·ç¡®è®¤æ‰€æœ‰å†…å®¹åï¼Œæˆ‘å°†å¼€å§‹å®æ–½ï¼**
