# 日志系统实现总结

## 完成时间
2025-11-27

## 实现内容

### 1. 后端日志系统 ✅

#### 核心文件
- `backend/src/common/logger/logger.service.ts` - 日志服务核心实现
- `backend/src/common/logger/logger.module.ts` - 日志模块
- `backend/src/common/logger/custom-logger.ts` - 自定义 Logger 类
- `backend/src/common/logger/logger.decorator.ts` - Logger 装饰器（可选）

#### 功能特性
- ✅ 统一日志格式：`[时间戳] 级别 [上下文] 消息 数据`
- ✅ 日志级别管理：ERROR、WARN、LOG、DEBUG、VERBOSE
- ✅ 文件输出：按日期分割日志文件
  - `logs/backend-YYYY-MM-DD.log` - 所有日志
  - `logs/backend-YYYY-MM-DD.error.log` - 仅错误日志
- ✅ 日志轮转：每天自动切换日志文件
- ✅ 环境配置：通过 `LOG_LEVEL` 和 `LOG_DIR` 环境变量配置
- ✅ 集成到 NestJS：已集成到 AppModule 和 main.ts

#### 使用示例
```typescript
import { CustomLogger } from '../common/logger/custom-logger';

export class UserService {
  private readonly logger = new CustomLogger(UserService.name);
  
  async createUser(data: CreateUserDto) {
    this.logger.log('开始创建用户', { username: data.username });
    // ...
  }
}
```

### 2. 前端日志系统 ✅

#### 管理端 (admin-portal)
- `admin-portal/src/utils/logger.ts` - 日志工具类

**功能特性**：
- ✅ 日志级别：ERROR、WARN、INFO、DEBUG
- ✅ 本地存储：自动保存到 localStorage
- ✅ 远程上报：可配置错误日志上报（可选）
- ✅ 自动清理：清理7天前的日志

#### 玩家端 (player-app)
- `player-app/src/utils/logger.ts` - 日志工具类

**功能特性**：
- ✅ 日志级别：ERROR、WARN、INFO、DEBUG（默认 WARN）
- ✅ 本地存储：仅保存错误日志
- ✅ 轻量级：减少内存占用

### 3. 日志清理脚本 ✅

- `scripts/clean-logs.js` - 日志清理脚本

**功能**：
- 清理指定天数前的日志文件
- 统计删除的文件数和释放的空间
- 支持自定义日志目录

**使用方法**：
```bash
# 清理30天前的日志（默认）
node scripts/clean-logs.js

# 清理7天前的日志
node scripts/clean-logs.js 7
```

### 4. 文档 ✅

- `docs/日志系统使用说明.md` - 完整的使用文档
- `backend/src/common/logger/README.md` - 后端日志使用示例

## 已更新的文件

### 后端
1. ✅ `backend/src/app.module.ts` - 添加 LoggerModule
2. ✅ `backend/src/main.ts` - 使用自定义 LoggerService
3. ✅ `backend/src/common/filters/http-exception.filter.ts` - 使用 LoggerService 记录错误
4. ✅ `backend/package.json` - 添加清理日志脚本

### 前端
1. ✅ `admin-portal/src/utils/logger.ts` - 管理端日志工具
2. ✅ `player-app/src/utils/logger.ts` - 玩家端日志工具

## 配置说明

### 后端环境变量
```env
# 日志级别: ERROR, WARN, LOG, DEBUG, VERBOSE
LOG_LEVEL=LOG

# 日志目录（可选，默认为 ./logs）
LOG_DIR=./logs
```

### 前端环境变量
```env
# 管理端日志级别: ERROR, WARN, INFO, DEBUG
VITE_LOG_LEVEL=INFO

# 玩家端日志级别（默认 WARN）
VITE_LOG_LEVEL=WARN
```

## 日志格式

### 后端日志格式
```
[2025-11-27 14:30:00.123] ERROR [HttpExceptionFilter] 服务器内部错误: POST /api/v1/users {"path":"/api/v1/users","method":"POST"}
```

### 前端日志格式
```json
{
  "timestamp": "2025-11-27T14:30:00.123Z",
  "level": "ERROR",
  "context": "UserService",
  "message": "操作失败",
  "data": { "userId": 123 },
  "stack": "Error: ..."
}
```

## 待完成工作

### 可选改进
1. ⏳ 逐步替换所有 `console.log/error/warn` 为 Logger（建议按模块逐步替换）
2. ⏳ 添加日志聚合服务集成（如 Sentry、ELK Stack）
3. ⏳ 添加日志查询 API（用于管理端查看日志）
4. ⏳ 添加日志监控和告警

## 使用建议

1. **生产环境**：
   - 后端：`LOG_LEVEL=WARN` 或 `LOG_LEVEL=ERROR`
   - 前端：`VITE_LOG_LEVEL=WARN` 或 `VITE_LOG_LEVEL=ERROR`

2. **开发环境**：
   - 后端：`LOG_LEVEL=DEBUG` 或 `LOG_LEVEL=LOG`
   - 前端：`VITE_LOG_LEVEL=DEBUG` 或 `VITE_LOG_LEVEL=INFO`

3. **定期清理**：
   - 建议每周运行一次清理脚本
   - 或设置定时任务自动清理

## 注意事项

1. 日志文件会占用磁盘空间，需要定期清理
2. localStorage 有大小限制（通常 5-10MB），前端日志会自动清理
3. 不要在日志中记录敏感信息（密码、token 等）
4. 生产环境避免使用 DEBUG 和 VERBOSE 级别

