# 问题类型下拉列表功能说明

## 功能概述

将问题类型从多选卡片改为下拉列表选择，并将其移至第一页（身份验证页面）。同时恢复区服选择功能，并实现重复问题类型检测。

## 主要变更

### 1. 身份验证页面 (IdentityCheck)

**新增字段:**
- 区服选择（必填）
- 问题类型下拉列表（必填）

**流程变更:**
1. 用户选择游戏
2. 根据游戏动态加载区服列表
3. 用户选择区服
4. 用户输入角色ID或昵称
5. 用户从下拉列表选择问题类型
6. 提交后检查是否有相同问题类型的未完成工单

**重复工单检测:**
- 如果检测到相同问题类型的未完成工单，弹出确认对话框
- 用户可选择：
  - 继续处理上次工单
  - 创建新工单

### 2. 问题反馈表单页面 (IntakeForm)

**移除内容:**
- 问题类型选择部分（已移至第一页）

**保留内容:**
- 问题描述
- 问题发生时间
- 问题截图上传
- 充值订单号

**数据来源:**
- 问题类型从 ticketStore 中获取（在第一页已选择）

### 3. 后端 API

**新增接口:**
```
POST /api/v1/tickets/check-open-by-issue-type
```

**请求参数:**
```json
{
  "gameId": "string",
  "serverId": "string",
  "playerIdOrName": "string",
  "issueTypeId": "string"
}
```

**响应:**
```json
{
  "success": true,
  "data": {
    "hasOpenTicket": false,
    "ticket": null
  }
}
```

如果有未完成工单:
```json
{
  "success": true,
  "data": {
    "hasOpenTicket": true,
    "ticket": {
      "id": "uuid",
      "ticketNo": "T-20251118-001",
      "token": "token-string"
    }
  }
}
```

### 4. 状态管理 (ticketStore)

**新增字段:**
- `issueTypeIds: string[]` - 存储选中的问题类型ID

**新增方法:**
- `setIssueTypes(issueTypeIds: string[])` - 设置问题类型

## 用户体验改进

1. **简化选择流程**: 问题类型改为下拉列表，更简洁直观
2. **提前选择**: 在第一页就选择问题类型，减少后续步骤
3. **智能检测**: 自动检测重复问题，避免重复提交
4. **灵活处理**: 用户可选择继续上次工单或创建新工单
5. **恢复区服**: 重新添加区服选择，满足业务需求

## 技术实现

### 前端

**文件变更:**
- `player-app/src/pages/IdentityCheck/index.tsx` - 添加区服和问题类型选择
- `player-app/src/pages/IntakeForm/index.tsx` - 移除问题类型选择
- `player-app/src/stores/ticketStore.ts` - 添加问题类型状态
- `player-app/src/services/ticket.service.ts` - 添加新API方法

**关键逻辑:**
```typescript
// 检查相同问题类型的未完成工单
const result = await checkOpenTicketByIssueType({
  gameId,
  serverId,
  playerIdOrName,
  issueTypeId,
});

if (result.hasOpenTicket) {
  // 弹出确认对话框
  Modal.confirm({
    title: '检测到未完成的工单',
    content: `您有一个相同问题类型的未完成工单...`,
    onOk: () => navigate('/escape-hatch'),
    onCancel: () => navigate('/intake-form'),
  });
}
```

### 后端

**文件变更:**
- `backend/src/ticket/ticket.controller.ts` - 添加新API端点
- `backend/src/ticket/ticket.service.ts` - 实现检测逻辑

**关键逻辑:**
```typescript
async checkOpenTicketByIssueType(
  gameId: string,
  serverId: string,
  playerIdOrName: string,
  issueTypeId: string,
) {
  const openTicket = await this.prisma.ticket.findFirst({
    where: {
      gameId,
      serverId,
      playerIdOrName,
      deletedAt: null,
      status: { not: 'CLOSED' },
      ticketIssueTypes: {
        some: { issueTypeId },
      },
    },
  });
  // ...
}
```

## 测试建议

1. **基本流程测试**
   - 选择游戏 → 选择区服 → 输入角色 → 选择问题类型 → 提交

2. **重复工单测试**
   - 创建一个工单（选择特定问题类型）
   - 不关闭该工单
   - 再次提交相同问题类型的工单
   - 验证是否弹出确认对话框

3. **边界情况测试**
   - 不同问题类型不应触发重复检测
   - 已关闭的工单不应触发重复检测
   - 不同区服的工单不应触发重复检测

## 数据库查询

查看某个玩家的未完成工单:
```sql
SELECT t.*, tit.issueTypeId, it.name as issueTypeName
FROM "Ticket" t
LEFT JOIN "TicketIssueType" tit ON t.id = tit.ticketId
LEFT JOIN "IssueType" it ON tit.issueTypeId = it.id
WHERE t.gameId = '1'
  AND t.serverId = 'server-1'
  AND t.playerIdOrName = 'test123'
  AND t.status != 'CLOSED'
  AND t.deletedAt IS NULL;
```

## 注意事项

1. **Prisma Client 重新生成**: 修改 schema 后需要运行 `npx prisma generate`
2. **TypeScript 类型**: IDE 可能需要重启才能识别新的 Prisma 类型
3. **向后兼容**: 旧的 API 端点仍然保留，不影响现有功能
4. **性能考虑**: 问题类型查询使用了索引优化

## 后续优化建议

1. 支持多个问题类型的重复检测
2. 显示未完成工单的详细信息
3. 添加工单合并功能
4. 优化下拉列表搜索体验
