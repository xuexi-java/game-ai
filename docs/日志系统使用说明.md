# 日志系统使用说明

## 概述

系统已建立完整的日志管理系统，包括后端日志服务和前端日志工具。

## 后端日志系统

### 功能特性

1. **统一日志格式**：所有日志使用统一的格式，包含时间戳、级别、上下文和消息
2. **日志级别管理**：支持 ERROR、WARN、LOG、DEBUG、VERBOSE 五个级别
3. **文件输出**：自动按日期分割日志文件，错误日志单独存储
4. **日志轮转**：每天自动切换日志文件，避免单个文件过大
5. **环境配置**：通过环境变量控制日志级别和输出目录

### 使用方法

#### 1. 在服务中使用 Logger

```typescript
import { Injectable } from '@nestjs/common';
import { CustomLogger } from '../common/logger/custom-logger';

@Injectable()
export class YourService {
  private readonly logger = new CustomLogger(YourService.name);

  someMethod() {
    this.logger.log('这是一条信息日志');
    this.logger.warn('这是一条警告日志');
    this.logger.error('这是一条错误日志', error.stack);
    this.logger.debug('这是一条调试日志'); // 仅在开发环境
  }
}
```

#### 2. 使用 NestJS 内置 Logger（已配置为使用自定义 LoggerService）

```typescript
import { Injectable, Logger } from '@nestjs/common';

@Injectable()
export class YourService {
  private readonly logger = new Logger(YourService.name);

  someMethod() {
    this.logger.log('信息日志');
    this.logger.warn('警告日志');
    this.logger.error('错误日志', error.stack);
  }
}
```

### 配置

在 `.env` 文件中配置：

```env
# 日志级别: ERROR, WARN, LOG, DEBUG, VERBOSE
LOG_LEVEL=LOG

# 日志目录（可选，默认为 ./logs）
LOG_DIR=./logs
```

### 日志文件

- `logs/backend-YYYY-MM-DD.log` - 所有日志
- `logs/backend-YYYY-MM-DD.error.log` - 仅错误日志

## 前端日志系统

### 管理端 (admin-portal)

#### 使用方法

```typescript
import { logger, logError, logWarn, logInfo, logDebug } from '@/utils/logger';

// 错误日志
logger.error('操作失败', error, 'UserService');
// 或使用便捷方法
logError('操作失败', error, 'UserService');

// 警告日志
logger.warn('数据可能不完整', { userId: 123 }, 'UserService');
logWarn('数据可能不完整', { userId: 123 }, 'UserService');

// 信息日志
logger.info('用户登录成功', { username: 'admin' }, 'AuthService');
logInfo('用户登录成功', { username: 'admin' }, 'AuthService');

// 调试日志（仅在开发环境输出到控制台）
logger.debug('调试信息', { data }, 'UserService');
logDebug('调试信息', { data }, 'UserService');
```

#### 配置

在 `.env` 文件中配置：

```env
# 日志级别: ERROR, WARN, INFO, DEBUG
VITE_LOG_LEVEL=INFO
```

#### 功能特性

- **本地存储**：错误和警告日志自动保存到 localStorage
- **远程上报**：可配置将错误日志上报到服务器（可选）
- **自动清理**：自动清理7天前的日志

#### 配置远程上报

```typescript
import { logger } from '@/utils/logger';

logger.configure({
  enableRemoteLogging: true,
  remoteLoggingEndpoint: 'https://api.example.com/logs',
});
```

### 玩家端 (player-app)

#### 使用方法

```typescript
import { logger, logError, logWarn } from '@/utils/logger';

// 玩家端默认只记录 ERROR 和 WARN
logger.error('加载失败', error, 'ChatPage');
logWarn('网络连接不稳定', null, 'WebSocketService');
```

#### 配置

在 `.env` 文件中配置：

```env
# 玩家端默认只记录 WARN 及以上级别
VITE_LOG_LEVEL=WARN
```

## 日志清理

### 自动清理

系统会自动清理旧日志：
- **后端**：日志文件按日期分割，建议定期清理30天前的日志
- **前端**：localStorage 中的日志自动清理7天前的数据

### 手动清理

使用清理脚本：

```bash
# 清理30天前的日志（默认）
node scripts/clean-logs.js

# 清理7天前的日志
node scripts/clean-logs.js 7

# 指定日志目录
node scripts/clean-logs.js 30 /path/to/logs
```

## 日志级别说明

### 后端

- **ERROR** (0): 错误日志，记录系统错误、异常等
- **WARN** (1): 警告日志，记录潜在问题、非致命错误
- **LOG** (2): 信息日志，记录重要的业务操作
- **DEBUG** (3): 调试日志，记录详细的调试信息（仅开发环境）
- **VERBOSE** (4): 详细日志，记录最详细的信息（仅开发环境）

### 前端

- **ERROR** (0): 错误日志，记录错误和异常
- **WARN** (1): 警告日志，记录警告信息
- **INFO** (2): 信息日志，记录重要操作（管理端）
- **DEBUG** (3): 调试日志，记录调试信息（仅开发环境）

## 最佳实践

1. **错误日志**：始终记录完整的错误信息，包括堆栈跟踪
2. **上下文信息**：提供足够的上下文信息，便于问题定位
3. **敏感信息**：不要在日志中记录密码、token 等敏感信息
4. **日志级别**：根据环境选择合适的日志级别
   - 生产环境：ERROR、WARN
   - 开发环境：ERROR、WARN、LOG、DEBUG
5. **性能考虑**：避免在高频操作中记录过多日志

## 日志查看

### 后端日志

```bash
# 查看今天的日志
tail -f logs/backend-$(date +%Y-%m-%d).log

# 查看今天的错误日志
tail -f logs/backend-$(date +%Y-%m-%d).error.log

# 搜索特定关键词
grep "ERROR" logs/backend-*.log
```

### 前端日志

在浏览器控制台中查看，或通过 localStorage 查看：

```javascript
// 查看今天的日志
const logs = JSON.parse(localStorage.getItem('app_logs_2025-11-27') || '[]');
console.table(logs);

// 查看错误日志
const errorLogs = logs.filter(log => log.level === 'ERROR');
console.table(errorLogs);
```

## 故障排查

### 日志文件过大

1. 检查日志级别设置，避免在生产环境使用 DEBUG 或 VERBOSE
2. 定期运行清理脚本
3. 考虑使用日志轮转工具（如 logrotate）

### 日志丢失

1. 检查日志目录权限
2. 检查磁盘空间
3. 检查日志级别设置是否过高

### 性能问题

1. 减少不必要的日志记录
2. 使用异步日志写入（已实现）
3. 在生产环境禁用 DEBUG 和 VERBOSE 级别

